<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>xct258</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="bg-layer"></div>
  <div id="loading">
    <div class="loading-spinner"></div>
    <div class="loading-text">åŠ è½½ä¸­...</div>
  </div>
  <div id="content" style="display:none;">
    <div id="app" class="app">
      <div class="page-shell">
          <div class="grid">
          <div class="metric-card" id="stat-todos-card" style="cursor: pointer;">
            <div class="card-icon-wrapper">
              <span class="card-icon">ğŸ“</span>
            </div>
            <div class="metric-content">
              <div class="metric-label">å¾…åŠ</div>
              <div class="metric-value" id="stat-todos-count">0</div>
            </div>
          </div>
          <div class="metric-card" id="stat-reminders-card" style="cursor: pointer;">
            <div class="card-icon-wrapper">
              <span class="card-icon">ğŸ””</span>
            </div>
            <div class="metric-content">
              <div class="metric-label">æé†’</div>
              <div class="metric-value" id="stat-reminders-count">0</div>
              <div class="metric-hint">æœªå¤„ç†</div>
            </div>
          </div>
          <div class="metric-card" id="stat-bookmarks-card" style="cursor: pointer;">
            <div class="card-icon-wrapper">
              <span class="card-icon">ğŸ”–</span>
            </div>
            <div class="metric-content">
              <div class="metric-label">ä¹¦ç­¾</div>
              <div class="metric-value" id="stat-bookmarks-count">0</div>
              <div class="metric-hint" id="bookmark-count-badge"></div>
            </div>
          </div>
          <div class="metric-card" id="stat-services-card" style="cursor: pointer;">
            <div class="card-icon-wrapper">
              <span class="card-icon">ğŸ–¥ï¸</span>
            </div>
            <div class="metric-content">
              <div class="metric-label">æœåŠ¡</div>
              <div class="metric-value" id="stat-services-count">0</div>
              <div class="metric-hint">çŠ¶æ€ç›‘æ§</div>
            </div>
          </div>
          <div class="metric-card" id="stat-ledger-card" style="cursor: pointer;">
            <div class="card-icon-wrapper">
              <span class="card-icon">ğŸ’°</span>
            </div>
            <div class="metric-content">
              <div class="metric-label">èµ„äº§æ€»è§ˆ</div>
              <div class="metric-value" id="stat-ledger-count">0</div>
              <div class="metric-hint" id="stat-ledger-hint">å‡€èµ„äº§</div>
            </div>
          </div>
        </div>
      </div>

      <!-- èµ„äº§ -->
      <div id="ledger-modal" class="screen-overlay" aria-hidden="true">
        <div class="screen-panel mini-panel" role="dialog" aria-modal="true" aria-label="è®°è´¦">
          <div class="mini-header">
            <div class="mini-header-top">
              <div class="mini-left">
                <button class="btn btn-ghost btn-small" id="ledger-back-btn" style="display:none; margin-right: 0.5rem;">â†</button>
                <button class="fab-button" id="open-ledger-form-btn" title="è®°ä¸€ç¬”">ğŸ’°</button>
              </div>

              <div class="mini-header-center">
                <span class="mini-title" id="ledger-modal-title">èµ„äº§æ€»è§ˆ</span>
              </div>

              <div class="mini-right">
                <div style="display:flex; gap:0.5rem; align-items:center; justify-content:flex-end;">
                  <button class="btn btn-ghost btn-small screen-back-btn" id="close-ledger-modal-btn" aria-label="å…³é—­">âœ•</button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="mini-body" style="display: flex; flex-direction: column;">
            <div id="ledger-overview-panel" class="ledger-overview-panel panel-fade">
                <div id="overview-card-net-worth" class="overview-clickable overview-card-large">
                   <div class="overview-label">å‡€èµ„äº§</div>
                   <div id="overview-net-worth" class="overview-value-large">--</div>
                </div>

                <div class="overview-section">
                    <div id="overview-card-assets" class="overview-clickable" style="flex: 1;">
                        <div class="overview-label">æ€»èµ„äº§</div>
                        <div id="overview-assets" class="overview-value" style="color: var(--text-accent-strong);">--</div>
                    </div>
                    <div id="overview-card-liabilities" class="overview-clickable" style="flex: 1;">
                        <div class="overview-label">æ€»è´Ÿå€º</div>
                        <div id="overview-liabilities" class="overview-value" style="color: var(--danger);">--</div>
                    </div>
                </div>

                <div class="overview-divider"></div>

                <div class="overview-section">
                    <div id="overview-card-income" class="overview-clickable" style="flex: 1;">
                        <div class="overview-label">æœ¬æœˆæ”¶å…¥</div>
                        <div id="overview-income" class="overview-value-medium" style="color: var(--success);">--</div>
                    </div>
                    <div id="overview-card-expense" class="overview-clickable" style="flex: 1;">
                        <div class="overview-label">æœ¬æœˆæ”¯å‡º</div>
                        <div id="overview-expense" class="overview-value-medium" style="color: var(--danger);">--</div>
                    </div>
                </div>
            </div>
            <div id="ledger-details-panel" class="panel-fade" style="display: none; flex: 1; flex-direction: column; height: 100%; overflow: hidden;">
                <div id="ledger-filters" class="bookmark-filter" style="flex-shrink: 0; position:sticky; top:0; z-index:5; background:var(--glass-bg-item); backdrop-filter:blur(10px); margin-bottom:0; border-bottom:1px solid var(--border); border-radius:0; padding: 0.5rem;"></div>
                <div id="ledger-list" style="flex: 1; overflow-y: auto;"></div>
            </div>

          </div>
        </div>
      </div>

      <!-- å¾…åŠ -->
      <div id="todos-modal" class="screen-overlay" aria-hidden="true">
        <div class="screen-panel mini-panel" role="dialog" aria-modal="true" aria-label="å¾…åŠ">
          <div class="mini-header">
            <div class="mini-header-top">
              <div class="mini-left">
                <button class="fab-button" id="open-todo-form-btn" title="æ·»åŠ å¾…åŠ">ğŸ“</button>
              </div>

              <div class="mini-header-center">
                <span class="mini-title">ğŸ“‹ å¾…åŠ</span>
              </div>

              <div class="mini-right">
                <div style="display:flex; gap:0.5rem; align-items:center; justify-content:flex-end;">
                  <button class="btn btn-ghost btn-small screen-back-btn" id="close-todos-modal-btn" aria-label="å…³é—­">âœ•</button>
                </div>
              </div>
            </div>

            <div class="mini-header-bottom header-filters secondary-row">
              <button class="btn btn-ghost btn-small filter-todo-btn active" data-priority="all">å…¨éƒ¨</button>
              <button class="btn btn-ghost btn-small filter-todo-btn" data-priority="high">é«˜</button>
              <button class="btn btn-ghost btn-small filter-todo-btn" data-priority="medium">ä¸­</button>
              <button class="btn btn-ghost btn-small filter-todo-btn" data-priority="low">ä½</button>
              <button class="btn btn-ghost btn-small filter-todo-btn" data-priority="completed">å®Œæˆ</button>
            </div>
          </div>
          <div class="mini-body" id="todo-list"></div>
        </div>
      </div>

      <!-- æé†’ -->
      <div id="reminders-modal" class="screen-overlay" aria-hidden="true">
        <div class="screen-panel mini-panel" role="dialog" aria-modal="true" aria-label="æé†’">
          <div class="mini-header">
            <div class="mini-header-top">
              <div class="mini-left">
                <button class="fab-button" id="open-reminder-form-btn" title="æ·»åŠ æé†’">âœï¸</button>
              </div>

              <div class="mini-header-center">
                <span class="mini-title">ğŸ”” æé†’</span>
              </div>

              <div class="mini-right">
                <div style="display:flex; gap:0.5rem; align-items:center; justify-content:flex-end;">
                  <button class="btn btn-ghost btn-small screen-back-btn" id="close-reminders-modal-btn" aria-label="å…³é—­">âœ•</button>
                </div>
              </div>
            </div>

            <div class="mini-header-bottom header-filters secondary-row">
              <button class="btn btn-ghost btn-small filter-reminder-btn active" data-filter="due">åˆ°æœŸ</button>
              <button class="btn btn-ghost btn-small filter-reminder-btn" data-filter="daily">æ¯æ—¥</button>
              <button class="btn btn-ghost btn-small filter-reminder-btn" data-filter="all">å…¨éƒ¨</button>
            </div>
          </div>
          <div class="mini-body" id="reminder-list"></div>
        </div>
      </div>

      <!-- ä¹¦ç­¾ -->
      <div id="bookmarks-modal" class="screen-overlay" aria-hidden="true">
        <div class="screen-panel mini-panel" role="dialog" aria-modal="true" aria-label="ä¹¦ç­¾">
          <div class="mini-header">
            <div class="mini-header-top">
              <div class="mini-left">
                <button class="fab-button" id="open-bookmark-form-btn" title="æ·»åŠ ä¹¦ç­¾">â•</button>
              </div>

              <div class="mini-header-center">
                <span class="mini-title">ğŸ”– ä¹¦ç­¾</span>
              </div>

              <div class="mini-right">
                <div style="display:flex; gap:0.5rem; align-items:center; justify-content:flex-end;">
                  <button class="btn btn-ghost btn-small screen-back-btn" id="close-bookmarks-modal-btn" aria-label="å…³é—­">âœ•</button>
                </div>
              </div>
            </div>

            <div class="mini-header-bottom header-filters secondary-row">
              <button class="btn btn-ghost btn-small" id="open-tag-filter-btn" title="ç­›é€‰æ ‡ç­¾" aria-label="ç­›é€‰æ ‡ç­¾">ç­›é€‰æ ‡ç­¾</button>
            </div>
          </div>
          <div class="mini-body">
            <div id="bookmark-grid" class="bookmark-grid"></div>
          </div>
        </div>
      </div>

      <!-- æœåŠ¡ -->
      <div id="services-modal" class="screen-overlay" aria-hidden="true">
        <div class="screen-panel mini-panel" role="dialog" aria-modal="true" aria-label="æœåŠ¡">
          <div class="mini-header">
            <div class="mini-header-top">
              <div class="mini-left">
                <button class="fab-button" id="refresh-services-btn" title="åˆ·æ–°">ğŸ”„</button>
              </div>

              <div class="mini-header-center">
                <span class="mini-title">ğŸ–¥ï¸ æœåŠ¡çŠ¶æ€</span>
              </div>

              <div class="mini-right">
                <div style="display:flex; gap:0.5rem; align-items:center; justify-content:flex-end;">
                  <button class="btn btn-ghost btn-small screen-back-btn" id="close-services-modal-btn" aria-label="å…³é—­">âœ•</button>
                </div>
              </div>
            </div>
          </div>
          <div class="mini-body" id="service-list"></div>
        </div>
      </div>

      <!-- æ·»åŠ å¾…åŠå¼¹çª— -->
      <div id="add-todo-modal" class="modal-overlay" style="display:none">
        <div class="modal-content">
          <div class="modal-header">
            <h3>æ·»åŠ å¾…åŠ</h3>
            <button class="modal-close" id="close-add-todo-btn">âœ•</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="todo-input">å†…å®¹</label>
              <input type="text" id="todo-input" placeholder="è¾“å…¥å¾…åŠäº‹é¡¹..." />
            </div>
            <div class="form-group">
              <label for="todo-details-input">è¯¦æƒ…ï¼ˆå¯é€‰ï¼‰</label>
              <textarea id="todo-details-input" placeholder="å¯é€‰ï¼šå¡«å†™æ›´å¤šè¯´æ˜" rows="3"></textarea>
            </div>
            <div class="form-group">
              <label for="todo-priority-select">ä¼˜å…ˆçº§</label>
              <select id="todo-priority-select">
                <option value="high">é«˜</option>
                <option value="medium" selected>ä¸­</option>
                <option value="low">ä½</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" id="cancel-add-todo-btn">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="add-todo-btn">æ·»åŠ </button>
          </div>
        </div>
      </div>

      <!-- ç¼–è¾‘å¾…åŠå¼¹çª— -->
      <div id="edit-todo-modal" class="modal-overlay" style="display:none">
        <div class="modal-content">
          <div class="modal-header">
            <h3>ç¼–è¾‘å¾…åŠ</h3>
            <button class="modal-close" id="close-edit-todo-btn">âœ•</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="edit-todo-input">å†…å®¹</label>
              <input type="text" id="edit-todo-input" placeholder="å¾…åŠäº‹é¡¹å†…å®¹" />
            </div>
            <div class="form-group">
              <label for="edit-todo-details-input">è¯¦æƒ…ï¼ˆå¯é€‰ï¼‰</label>
              <textarea id="edit-todo-details-input" placeholder="å¯é€‰ï¼šå¡«å†™æ›´å¤šè¯´æ˜" rows="3"></textarea>
            </div>
            <div class="form-group">
              <label for="edit-todo-priority-select">ä¼˜å…ˆçº§</label>
              <select id="edit-todo-priority-select">
                <option value="high">é«˜</option>
                <option value="medium">ä¸­</option>
                <option value="low">ä½</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" id="cancel-edit-todo-btn">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="save-edit-todo-btn">ä¿å­˜</button>
          </div>
        </div>
      </div>

      <!-- æ·»åŠ æé†’å¼¹çª— -->
      <div id="reminder-modal" class="modal-overlay" style="display:none">
        <div class="modal-content">
          <div class="modal-header">
            <h3>æ·»åŠ æé†’</h3>
            <button class="modal-close" id="close-reminder-modal-btn">âœ•</button>
          </div>
          <div class="modal-body">
            <div class="form-note">æé†’ç±»å‹é»˜è®¤ä¸ºâ€œå•æ¬¡â€ã€‚å¦‚éœ€è®¾ç½®ä¸ºæ¯æ—¥æé†’ï¼Œè¯·åœ¨â€œæ˜¯å¦å¾ªç¯â€ä¸­é€‰æ‹©â€œæ¯æ—¥â€ã€‚</div>
            <div class="form-group">
              <label for="reminder-service-input">æœåŠ¡åç§°</label>
              <input type="text" id="reminder-service-input" placeholder="ä¾‹å¦‚ï¼šé˜¿é‡Œäº‘æœåŠ¡å™¨" />
            </div>
            <div class="form-group">
              <label for="reminder-content-input">æé†’å†…å®¹</label>
              <input type="text" id="reminder-content-input" placeholder="ä¾‹å¦‚ï¼šå¹´è´¹åˆ°æœŸéœ€ç»­è´¹" />
            </div>
            <div class="form-group" id="reminder-recurring-group">
              <label><input type="checkbox" id="reminder-recurring-checkbox" /> æ˜¯å¦å¾ªç¯</label>
              <div id="reminder-cycle-group" style="margin-top:0.5rem; display:none">
                <label for="reminder-cycle-mode">å¾ªç¯æ¨¡å¼</label>
                <select id="reminder-cycle-mode">
                  <option value="daily">æ¯æ—¥</option>
                  <option value="days">æŒ‰å¤©</option>
                  <option value="month_start">æ¯æœˆ</option>
                  <option value="next_month_same_day">åˆ°æœŸä¸‹æœˆåŒæ—¥</option>
                </select>
                <div id="reminder-cycle-days-group" style="margin-top:0.5rem;">
                  <label for="reminder-cycle-days">å¾ªç¯å‘¨æœŸï¼ˆå¤©ï¼‰</label>
                  <input type="number" id="reminder-cycle-days" value="" min="1" />
                </div>
              </div>
            </div>
            <div class="form-group" id="reminder-due-group">
              <label for="reminder-time-input">åˆ°æœŸæ—¶é—´</label>
              <input type="date" id="reminder-time-input" />
            </div>
            <div class="form-group" id="reminder-advance-group">
              <label for="reminder-days-input">æå‰æé†’ï¼ˆå¤©ï¼‰</label>
              <input type="number" id="reminder-days-input" placeholder="ä¾‹å¦‚ï¼š30" value="30" min="0" />
            </div> 
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" id="cancel-reminder-btn">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="add-reminder-btn">æ·»åŠ </button>
          </div>
        </div>
      </div>

      <!-- æ·»åŠ ä¹¦ç­¾å¼¹çª— -->
      <div id="bookmark-modal" class="modal-overlay" style="display:none">
        <div class="modal-content">
          <div class="modal-header">
            <h3>æ·»åŠ ä¹¦ç­¾</h3>
            <button class="modal-close" id="close-bookmark-modal-btn">âœ•</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="bookmark-title-input">åç§°</label>
              <input type="text" id="bookmark-title-input" placeholder="ä¾‹å¦‚ï¼šGitHub" />
            </div>
            <div class="form-group">
              <label for="bookmark-url-input">ç½‘å€</label>
              <input type="text" id="bookmark-url-input" placeholder="ä¾‹å¦‚ï¼šhttps://github.com" />
            </div>
            <div class="form-group">
              <label for="bookmark-description-input">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
              <textarea id="bookmark-description-input" placeholder="" rows="2"></textarea>
            </div>
            <div class="form-group">
              <label for="bookmark-tags-input">æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰</label>
              <div class="tags-editor" id="bookmark-tags-editor">
                <div class="tags-container" id="bookmark-tags-container"></div>
                <input type="text" id="bookmark-tags-input" placeholder="è¾“å…¥æ ‡ç­¾åæŒ‰å›è½¦" class="tags-input" />
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" id="cancel-bookmark-btn">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="add-bookmark-btn">æ·»åŠ </button>
          </div>
        </div>
      </div>

      <!-- ç¼–è¾‘ä¹¦ç­¾å¼¹çª— -->
      <div id="edit-bookmark-modal" class="modal-overlay" style="display:none">
        <div class="modal-content">
          <div class="modal-header">
            <h3>ç¼–è¾‘ä¹¦ç­¾</h3>
            <button class="modal-close" id="close-edit-bookmark-btn">âœ•</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="edit-bookmark-title-input">åç§°</label>
              <input type="text" id="edit-bookmark-title-input" placeholder="ä¹¦ç­¾åç§°" />
            </div>
            <div class="form-group">
              <label for="edit-bookmark-url-input">ç½‘å€</label>
              <input type="text" id="edit-bookmark-url-input" placeholder="https://..." />
            </div>
            <div class="form-group">
              <label for="edit-bookmark-description-input">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
              <textarea id="edit-bookmark-description-input" placeholder="" rows="2"></textarea>
            </div>
            <div class="form-group">
              <label for="edit-bookmark-tags-input">æ ‡ç­¾</label>
              <div class="tags-editor" id="edit-bookmark-tags-editor">
                <div class="tags-container" id="edit-bookmark-tags-container"></div>
                <input type="text" id="edit-bookmark-tags-input" placeholder="è¾“å…¥æ ‡ç­¾åæŒ‰å›è½¦" class="tags-input" />
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" id="cancel-edit-bookmark-btn">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="save-edit-bookmark-btn">ä¿å­˜</button>
          </div>
        </div>
      </div>

      <!-- ç¼–è¾‘æé†’å¼¹çª— -->
      <div id="edit-reminder-modal" class="modal-overlay" style="display:none">
        <div class="modal-content">
          <div class="modal-header">
            <h3>ç¼–è¾‘æé†’</h3>
            <button class="modal-close" id="close-edit-reminder-btn">âœ•</button>
          </div>
          <div class="modal-body">
            <div class="form-note">é»˜è®¤å•æ¬¡ï¼›åœ¨â€œæ˜¯å¦å¾ªç¯â€ä¸­é€‰æ‹©â€œæ¯æ—¥â€å³å¯å°†æé†’æ”¹ä¸ºæ¯æ—¥ã€‚</div>
            <div class="form-group">
              <label for="edit-reminder-service-input">æœåŠ¡åç§°</label>
              <input type="text" id="edit-reminder-service-input" placeholder="ä¾‹å¦‚ï¼šé˜¿é‡Œäº‘æœåŠ¡å™¨" />
            </div>
            <div class="form-group">
              <label for="edit-reminder-content-input">æé†’å†…å®¹</label>
              <input type="text" id="edit-reminder-content-input" placeholder="ä¾‹å¦‚ï¼šå¹´è´¹åˆ°æœŸéœ€ç»­è´¹" />
            </div>
            <div class="form-group" id="edit-reminder-recurring-group">
              <label><input type="checkbox" id="edit-reminder-recurring-checkbox" /> æ˜¯å¦å¾ªç¯</label>
              <div id="edit-reminder-cycle-group" style="margin-top:0.5rem; display:none">
                <label for="edit-reminder-cycle-mode">å¾ªç¯æ¨¡å¼</label>
                <select id="edit-reminder-cycle-mode">
                  <option value="daily">æ¯æ—¥</option>
                  <option value="days">æŒ‰å¤©</option>
                  <option value="month_start">æ¯æœˆ</option>
                  <option value="next_month_same_day">åˆ°æœŸä¸‹æœˆåŒæ—¥</option>
                </select>
                <div id="edit-reminder-cycle-days-group" style="margin-top:0.5rem;">
                  <label for="edit-reminder-cycle-days">å¾ªç¯å‘¨æœŸï¼ˆå¤©ï¼‰</label>
                  <input type="number" id="edit-reminder-cycle-days" value="" min="1" />
                </div>
              </div>
            </div>
            <div class="form-group" id="edit-reminder-due-group">
              <label for="edit-reminder-time-input">åˆ°æœŸæ—¶é—´</label>
              <input type="date" id="edit-reminder-time-input" />
            </div>
            <div class="form-group" id="edit-reminder-advance-group">
              <label for="edit-reminder-days-input">æå‰æé†’ï¼ˆå¤©ï¼‰</label>
              <input type="number" id="edit-reminder-days-input" placeholder="ä¾‹å¦‚ï¼š30" value="30" min="0" />
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" id="cancel-edit-reminder-btn">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="save-edit-reminder-btn">ä¿å­˜</button>
          </div>
        </div>
      </div>

      <!-- æ·»åŠ è®°è´¦å¼¹çª— -->
      <div id="ledger-form-modal" class="modal-overlay" style="display:none">
        <div class="modal-content">
          <div class="modal-header">
            <h3>è®°ä¸€ç¬”</h3>
            <button class="modal-close" id="close-ledger-form-btn">âœ•</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="ledger-type-select">ç±»å‹</label>
              <select id="ledger-type-select">
                <option value="expense" selected>æ”¯å‡º</option>
                <option value="income">æ”¶å…¥</option>
                <option value="debt_in">å€Ÿå…¥ (å¢åŠ è´Ÿå€º)</option>
                <option value="debt_out">è¿˜æ¬¾ (å‡å°‘è´Ÿå€º)</option>
              </select>
            </div>
            <div class="form-group">
              <label for="ledger-amount-input">é‡‘é¢</label>
              <input type="number" id="ledger-amount-input" placeholder="0.00" step="0.01" />
            </div>
            <div class="form-group" id="ledger-interest-group" style="display:none;">
              <label for="ledger-interest-input">é¢å¤–åˆ©æ¯</label>
              <input type="number" id="ledger-interest-input" placeholder="0.00" step="0.01" />
              <div class="form-note">æ€»æ”¯å‡º = æœ¬é‡‘(ä¸Šæ–¹é‡‘é¢) + é¢å¤–åˆ©æ¯ã€‚</div>
            </div>
            <div class="form-group">
              <label for="ledger-item-input">é¡¹ç›®åç§°</label>
              <input type="text" id="ledger-item-input" placeholder="ä¾‹å¦‚ï¼šåˆé¤" />
            </div>
            <div class="form-group">
              <label for="ledger-date-input">æ—¥æœŸ</label>
              <input type="date" id="ledger-date-input" />
            </div>
            <div class="form-group">
              <label for="ledger-category-input">åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</label>
              <input type="text" id="ledger-category-input" placeholder="ä¾‹å¦‚ï¼šé¤é¥®" />
            </div>
            <div class="form-group">
              <label for="ledger-notes-input">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
              <textarea id="ledger-notes-input" rows="2"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" id="cancel-ledger-form-btn">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="save-ledger-btn">ä¿å­˜</button>
          </div>
        </div>
      </div>

      <!-- å…¨å±€æ ‡ç­¾ç­›é€‰å¼¹çª— -->
      <div id="tag-filter-modal" class="modal-overlay" style="display:none">
        <div class="modal-content">
          <div class="modal-header">
            <h3>ç­›é€‰æ ‡ç­¾</h3>
            <button class="modal-close" id="close-tag-filter-modal">âœ•</button>
          </div>
          <div class="modal-body">
            <div id="tag-filter-list" class="tag-filter-list"></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" id="cancel-tag-filter-btn">å®Œæˆ</button>
          </div>
        </div>
      </div>

      <!-- ç‚¹å‡»å¡ç‰‡åæ˜¾ç¤ºè¯¥å¡ç‰‡çš„æ ‡ç­¾ï¼ˆç‚¹å‡»æ ‡ç­¾æ‰“å¼€ç½‘ç«™ï¼‰ -->
      <div id="tag-select-modal" class="modal-overlay" style="display:none">
        <div class="modal-content">
          <div class="modal-header">
            <h3>é€‰æ‹©æ ‡ç­¾</h3>
            <button class="modal-close" id="close-tag-select-modal">âœ•</button>
          </div>
          <div class="modal-body">
            <div id="tag-select-list" class="tag-select-list"></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" id="cancel-tag-select-btn">å®Œæˆ</button>
          </div>
        </div>
      </div>

      <!-- æ¶ˆæ¯æç¤º -->
      <div id="message-toast" class="toast" aria-live="polite" role="status"></div>
    </div>
  </div>

<script>
  // ============================================================================
  // ä¸»é¢˜é…ç½®ä¸åˆå§‹åŒ–
  // ============================================================================
  const THEME_API = 'https://random-image.p1.xct258.top/';
  const FALLBACK_THEME = [84, 114, 160];

  /**
   * è®¾ç½®ä¸»é¢˜è‰² CSS å˜é‡
   */
  function setThemeVariables(rgb) {
    const root = document.documentElement;
    const r = Number(rgb[0]) || 0;
    const g = Number(rgb[1]) || 0;
    const b = Number(rgb[2]) || 0;

    const clamp = (n) => Math.max(0, Math.min(255, n));
    const rgba = (a) => `rgba(${r}, ${g}, ${b}, ${a})`;
    const mix = (a, b, t) => Math.round(a * (1 - t) + b * t);
    const mixRgb = (tr, tg, tb, t) => [mix(r, tr, t), mix(g, tg, t), mix(b, tb, t)];

    // äº®åº¦ä¼°ç®—ï¼ˆç”¨äºç”Ÿæˆæ›´ç¨³çš„æ–‡å­—è‰²/hover è‰²ï¼‰
    const luminance = 0.2126 * r + 0.7152 * g + 0.0722 * b;

    // hoverï¼šè½»å¾®æäº®
    const hr = clamp(r + 28);
    const hg = clamp(g + 28);
    const hb = clamp(b + 28);

    // inkï¼šç”¨äºæµ…è‰²ç»ç’ƒé¢æ¿ä¸Šçš„â€œä¸»é¢˜è‰²æ–‡å­—â€ï¼Œé¿å…è¿‡äº®/è¿‡æš—å¯¼è‡´å¯è¯»æ€§å·®
    const inkDelta = 110;
    const ir = clamp(luminance > 160 ? r - inkDelta : r + inkDelta);
    const ig = clamp(luminance > 160 ? g - inkDelta : g + inkDelta);
    const ib = clamp(luminance > 160 ? b - inkDelta : b + inkDelta);

    // æ ¹æ®ä¸»é¢˜è‰²äº®åº¦é€‰æ‹©ä¸­æ€§æ­£æ–‡è‰²ï¼ˆé¿å¼€ä¸»é¢˜è‰²ï¼Œä¼˜å…ˆä¿è¯å¯è¯»æ€§ï¼‰
    const isDarkTheme = luminance < 135;
    const textColor = isDarkTheme ? '#f8fafc' : '#0f172a';
    const mutedColor = isDarkTheme ? 'rgba(248, 250, 252, 0.78)' : '#475569';
    const borderColor = isDarkTheme ? 'rgba(248, 250, 252, 0.18)' : 'rgba(15, 23, 42, 0.12)';

    // ä¸»é¢˜åŒ–æ–‡å­—ï¼šåœ¨â€œè´´è¿‘ä¸»é¢˜â€å’Œâ€œå¯è¯»æ€§â€ä¹‹é—´æŠ˜ä¸­ï¼ˆä¸ç›´æ¥ç”¨çº¯ä¸»é¢˜è‰²ï¼‰
    // æ·±è‰²ä¸»é¢˜ï¼šå‘ç™½è‰²æ··åˆè®©æ–‡å­—æ›´äº®ï¼›æµ…è‰²ä¸»é¢˜ï¼šå‘é»‘è‰²æ··åˆè®©æ–‡å­—æ›´æ·±ã€‚
    const [acr, acg, acb] = isDarkTheme ? mixRgb(255, 255, 255, 0.52) : mixRgb(0, 0, 0, 0.52);
    const [asr, asg, asb] = isDarkTheme ? mixRgb(255, 255, 255, 0.64) : mixRgb(0, 0, 0, 0.64);
    const [awr, awg, awb] = isDarkTheme ? mixRgb(255, 255, 255, 0.40) : mixRgb(0, 0, 0, 0.40);
    const accentText = `rgb(${acr}, ${acg}, ${acb})`;
    const accentStrongText = `rgb(${asr}, ${asg}, ${asb})`;
    const accentWeakText = `rgb(${awr}, ${awg}, ${awb})`;
    const accentMutedText = isDarkTheme
      ? `rgba(${acr}, ${acg}, ${acb}, 0.78)`
      : `rgba(${acr}, ${acg}, ${acb}, 0.70)`;
    const linkText = accentStrongText;

    // ç»Ÿä¸€å¯è¯»çš„æ–‡å­—é˜´å½±ï¼ˆèƒŒæ™¯å›¾/ç»ç’ƒåº•ä¸‹æ›´ç¨³ï¼‰
    const textShadow = isDarkTheme ? 'rgba(0, 0, 0, 0.35)' : 'rgba(255, 255, 255, 0.55)';

    root.style.setProperty('--theme-r', r);
    root.style.setProperty('--theme-g', g);
    root.style.setProperty('--theme-b', b);

    root.style.setProperty('--primary', `rgb(${r}, ${g}, ${b})`);
    root.style.setProperty('--primary-hover', `rgb(${hr}, ${hg}, ${hb})`);
    root.style.setProperty('--primary-8', rgba(0.08));
    root.style.setProperty('--primary-16', rgba(0.16));
    root.style.setProperty('--primary-24', rgba(0.24));
    root.style.setProperty('--primary-32', rgba(0.32));
    root.style.setProperty('--primary-40', rgba(0.40));
    root.style.setProperty('--primary-ink', `rgb(${ir}, ${ig}, ${ib})`);

    // æ­£æ–‡/å¼±åŒ–æ–‡å­—/è¾¹æ¡†ï¼šéšä¸»é¢˜äº®åº¦åˆ‡æ¢ï¼Œä½†ä¿æŒä¸­æ€§ï¼ˆä¸æŸ“ä¸»é¢˜è‰²ï¼‰
    root.style.setProperty('--text', textColor);
    root.style.setProperty('--muted', mutedColor);
    root.style.setProperty('--border', borderColor);

    // Modal/input theme variants (keep contrast regardless of global text color)
    root.style.setProperty('--modal-bg', isDarkTheme ? 'rgba(6, 8, 13, 0.92)' : 'rgba(255, 255, 255, 0.9)');
    root.style.setProperty('--modal-text', textColor);
    root.style.setProperty('--modal-footer-bg', isDarkTheme ? 'rgba(255,255,255,0.02)' : 'rgba(248, 251, 255, 0.5)');
    root.style.setProperty('--input-bg', isDarkTheme ? 'rgba(12, 18, 38, 0.85)' : 'rgba(255, 255, 255, 0.9)');
    root.style.setProperty('--input-bg-focus', isDarkTheme ? 'rgba(12, 18, 38, 1)' : 'rgba(255, 255, 255, 1)');
    root.style.setProperty('--input-text', textColor);
    root.style.setProperty('--placeholder', isDarkTheme ? 'rgba(248,250,252,0.6)' : 'rgba(11,18,32,0.5)');

    // æ›´â€œä¸»é¢˜åŒ–â€çš„æ–‡å­—å±‚çº§ï¼ˆç”¨äºæ ‡é¢˜/æ•°å­—/å¼ºè°ƒä¿¡æ¯ï¼‰
    root.style.setProperty('--text-accent', accentText);
    root.style.setProperty('--text-accent-strong', accentStrongText);
    root.style.setProperty('--text-accent-weak', accentWeakText);
    root.style.setProperty('--text-accent-muted', accentMutedText);
    root.style.setProperty('--text-link', linkText);
    root.style.setProperty('--text-shadow', textShadow);

    // ä¸»é¢˜è‰²èƒŒæ™¯ä¸Šçš„å‰æ™¯æ–‡å­—è‰²ï¼ˆæŒ‰é’®ç­‰ï¼‰
    root.style.setProperty('--on-primary', luminance > 160 ? '#0f172a' : '#fff');
  }

  /**
   * å¿«é€Ÿè·å–ä¸»é¢˜è‰²
   */
  async function fetchAndApplyThemeColor() {
    try {
      const res = await fetch(THEME_API, { method: 'HEAD', cache: 'no-store' });
      const themeHeader = res.headers.get('X-Theme-Color');
      const nums = themeHeader ? themeHeader.match(/\d+/g) : null;
      const rgb = nums ? nums.map(Number) : FALLBACK_THEME;
      setThemeVariables(rgb);
    } catch (e) {
      setThemeVariables(FALLBACK_THEME);
    }
  }

  /**
   * è·å–å¹¶åº”ç”¨ä¸»é¢˜èƒŒæ™¯
   */
  async function fetchAndApplyThemeBackground() {
    try {
      const res = await fetch(THEME_API);
      const themeHeader = res.headers.get('X-Theme-Color');
      const nums = themeHeader ? themeHeader.match(/\d+/g) : null;
      if (nums) setThemeVariables(nums.map(Number));

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const bgLayer = document.getElementById('bg-layer');
      if (bgLayer) bgLayer.style.backgroundImage = `url('${url}')`;
      return true;
    } catch (e) {
      console.warn('ä¸»é¢˜èƒŒæ™¯åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å›é€€è‰²', e);
      setThemeVariables(FALLBACK_THEME);
      return false;
    }
  }

  // ============================================================================
  // API æœåŠ¡å±‚
  // ============================================================================
  const ApiService = {
    // ä¼˜å…ˆåˆ—è¡¨ï¼šå…ˆå°è¯•ç›¸å¯¹è·¯å¾„ /apiï¼Œå¤±è´¥åˆ™å°è¯•çº¿ä¸Šå®Œæ•´åœ°å€
    bases: ['/api', 'https://taskops-api.p1.xct258.top'],

    async request(endpoint, options = {}) {
      let lastError;

      for (const base of this.bases) {
        try {
          const url = `${base}${endpoint}`;
          const response = await fetch(url, {
            headers: { 'Content-Type': 'application/json' },
            ...options
          });

          if (response.ok) {
            return await response.json();
          }

          // å¦‚æœæ˜¯ 404 (æœ¬åœ°æ— ä»£ç†) æˆ– 5xx (æœåŠ¡æŒ‚äº†)ï¼Œå°è¯•ä¸‹ä¸€ä¸ªåœ°å€
          // 4xx (å¦‚ 400 å‚æ•°é”™è¯¯, 401 æœªæˆæƒ) é€šå¸¸æ˜¯ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼Œä¸åº”åˆ‡æ¢ç¯å¢ƒ
          if (response.status === 404 || response.status >= 500) {
            console.warn(`[API] è·¯å¾„ ${base} ä¸å¯ç”¨ (${response.status})ï¼Œå°è¯•åˆ‡æ¢å¤‡ç”¨åœ°å€...`);
            lastError = new Error(`HTTP ${response.status}`);
            continue;
          }

          throw new Error(`HTTP ${response.status}`);
          
        } catch (error) {
          console.warn(`[API] è¿æ¥ ${base} å¤±è´¥: ${error.message}ï¼Œå°è¯•åˆ‡æ¢å¤‡ç”¨åœ°å€...`);
          lastError = error;
          // ç½‘ç»œé”™è¯¯(fetch throw) æˆ– ä¸Šé¢æŠ›å‡ºçš„ 404/5xxï¼Œç»§ç»­å°è¯•ä¸‹ä¸€ä¸ª base
          continue;
        }
      }
      
      throw new Error(`API Error: ${lastError ? lastError.message : 'Unknown error'}`);
    },

    // Use PUT for updates (backend expects PUT). No fallback to PATCH to avoid inconsistency.
    async updateWithFallback(endpoint, data) {
      return await this.request(endpoint, { method: 'PUT', body: JSON.stringify(data) });
    },

    todos: {
      getAll: () => ApiService.request('/todos'),
      create: (data) => ApiService.request('/todos', { method: 'POST', body: JSON.stringify(data) }),
      update: (id, data) => ApiService.updateWithFallback(`/todos/${id}`, data),
      delete: (id) => ApiService.request(`/todos/${id}`, { method: 'DELETE' })
    },

    reminders: {
      getAll: () => ApiService.request('/reminders'),
      create: (data) => ApiService.request('/reminders', { method: 'POST', body: JSON.stringify(data) }),
      update: (id, data) => ApiService.updateWithFallback(`/reminders/${id}`, data),
      markProcessed: (id) => ApiService.request(`/reminders/${id}/processed`, { method: 'PUT' }),
      delete: (id) => ApiService.request(`/reminders/${id}`, { method: 'DELETE' })
    },
    bookmarks: {
      getAll: () => ApiService.request('/bookmarks'),
      create: (data) => ApiService.request('/bookmarks', { method: 'POST', body: JSON.stringify(data) }),
      update: (id, data) => ApiService.updateWithFallback(`/bookmarks/${id}`, data),
      delete: (id) => ApiService.request(`/bookmarks/${id}`, { method: 'DELETE' })
    },
    serverStatus: {
      getAll: (limit = 50) => ApiService.request(`/server/status?limit=${limit}`)
    },
    ledger: {
      getAll: () => ApiService.request('/ledger'),
      getAsset: () => ApiService.request('/asset'),
      getLiability: () => ApiService.request('/liability'),
      updateAsset: (amount) => ApiService.request('/asset', { method: 'POST', body: JSON.stringify({ amount }) }),
      updateLiability: (amount) => ApiService.request('/liability', { method: 'POST', body: JSON.stringify({ amount }) }),
      create: (data) => ApiService.request('/ledger', { method: 'POST', body: JSON.stringify(data) }),
      update: (id, data) => ApiService.updateWithFallback(`/ledger/${id}`, data),
      delete: (id) => ApiService.request(`/ledger/${id}`, { method: 'DELETE' })
    }
  };

  // ============================================================================
  // åº”ç”¨çŠ¶æ€ç®¡ç†
  // ============================================================================
  const AppState = {
    todos: [],
    reminders: [],
    editingTodoId: null,
    bookmarks: [],
    serverStatus: [],
    ledger: [],
    asset: null,
    liability: null,
    editingLedgerId: null,
    editingBookmarkId: null,
    currentEditReminderId: null,
    todoFilterPriority: 'all',
    reminderFilter: 'due',  // 'due' æˆ– 'all'
    screenOpen: false, // æ ‡è®°ä»»ä½•æ¨¡æ€æ¡†æ˜¯å¦æ‰“å¼€
    bookmarkFilterTags: []

  };

  // ============================================================================
  // DOM ç¼“å­˜
  // ============================================================================
  const DOM = {
    // Modals
    addTodoModal: document.getElementById('add-todo-modal'),
    editTodoModal: document.getElementById('edit-todo-modal'),
    reminderModal: document.getElementById('reminder-modal'),
    ledgerFormModal: document.getElementById('ledger-form-modal'),

    // Todo Form
    todoInput: document.getElementById('todo-input'),
    todoPrioritySelect: document.getElementById('todo-priority-select'),
    todoDetailsInput: document.getElementById('todo-details-input'),
    editTodoInput: document.getElementById('edit-todo-input'),
    editTodoPriority: document.getElementById('edit-todo-priority-select'),
    editTodoDetails: document.getElementById('edit-todo-details-input'),

    // Reminder Form
    reminderServiceInput: document.getElementById('reminder-service-input'),
    reminderContentInput: document.getElementById('reminder-content-input'),
    reminderTimeInput: document.getElementById('reminder-time-input'),
    reminderDaysInput: document.getElementById('reminder-days-input'),
    reminderRecurringCheckbox: document.getElementById('reminder-recurring-checkbox'),
    reminderCycleModeSelect: document.getElementById('reminder-cycle-mode'),
    reminderCycleDaysInput: document.getElementById('reminder-cycle-days'),
    reminderCycleDaysGroup: document.getElementById('reminder-cycle-days-group'),

    // Ledger Form
    ledgerTypeSelect: document.getElementById('ledger-type-select'),
    ledgerAmountInput: document.getElementById('ledger-amount-input'),
    ledgerItemInput: document.getElementById('ledger-item-input'),
    ledgerDateInput: document.getElementById('ledger-date-input'),
    ledgerCategoryInput: document.getElementById('ledger-category-input'),
    ledgerNotesInput: document.getElementById('ledger-notes-input'),
    saveLedgerBtn: document.getElementById('save-ledger-btn'),
    cancelLedgerFormBtn: document.getElementById('cancel-ledger-form-btn'),
    closeLedgerFormBtn: document.getElementById('close-ledger-form-btn'),
    openLedgerFormBtn: document.getElementById('open-ledger-form-btn'),

    // Lists
    todoList: document.getElementById('todo-list'),
    reminderList: document.getElementById('reminder-list'),
    bookmarkGrid: document.getElementById('bookmark-grid'),
    ledgerList: document.getElementById('ledger-list'),
    serviceList: document.getElementById('service-list'),

    // Badges & Buttons
    bookmarkCountBadge: document.getElementById('bookmark-count-badge'),
    // ä¹¦ç­¾åŒºåŸŸæ·»åŠ å…¥å£
    openBookmarkFormBtn: document.getElementById('open-bookmark-form-btn'),
    openTodoFormBtn: document.getElementById('open-todo-form-btn'),
    openReminderFormBtn: document.getElementById('open-reminder-form-btn'),
    statTodos: document.getElementById('stat-todos-count'),
    statReminders: document.getElementById('stat-reminders-count'),
    statRemindersCard: document.getElementById('stat-reminders-card'),
    statRemindersHintEl: document.querySelector('#stat-reminders-card .metric-hint'),
    statBookmarks: document.getElementById('stat-bookmarks-count'),
    statServices: document.getElementById('stat-services-count'),
    statServicesCard: document.getElementById('stat-services-card'),
    statLedger: document.getElementById('stat-ledger-count'),
    statLedgerCard: document.getElementById('stat-ledger-card'),
    statLedgerHint: document.getElementById('stat-ledger-hint'),
    ledgerMonthExpense: document.getElementById('ledger-month-expense'),
    statLedgerSummary: document.getElementById('ledger-summary-container'),

    // Modal Controls
    closeAddTodoBtn: document.getElementById('close-add-todo-btn'),
    cancelAddTodoBtn: document.getElementById('cancel-add-todo-btn'),
    addTodoBtn: document.getElementById('add-todo-btn'),
    closeEditTodoBtn: document.getElementById('close-edit-todo-btn'),
    cancelEditTodoBtn: document.getElementById('cancel-edit-todo-btn'),
    saveEditTodoBtn: document.getElementById('save-edit-todo-btn'),
    closeReminderModalBtn: document.getElementById('close-reminder-modal-btn'),
    cancelReminderBtn: document.getElementById('cancel-reminder-btn'),
    addReminderBtn: document.getElementById('add-reminder-btn'),
    // Bookmark
    bookmarkModal: document.getElementById('bookmark-modal'),
    closeBookmarkModalBtn: document.getElementById('close-bookmark-modal-btn'),
    cancelBookmarkBtn: document.getElementById('cancel-bookmark-btn'),
    addBookmarkBtn: document.getElementById('add-bookmark-btn'),
    bookmarkTitleInput: document.getElementById('bookmark-title-input'),
    bookmarkUrlInput: document.getElementById('bookmark-url-input'),
    bookmarkDescriptionInput: document.getElementById('bookmark-description-input'),
    bookmarkTagsInput: document.getElementById('bookmark-tags-input'),
    editBookmarkDescriptionInput: document.getElementById('edit-bookmark-description-input'),
    editBookmarkModal: document.getElementById('edit-bookmark-modal'),
    openTagFilterBtn: document.getElementById('open-tag-filter-btn'),
    tagFilterModal: document.getElementById('tag-filter-modal'),
    tagFilterList: document.getElementById('tag-filter-list'),
    closeTagFilterBtn: document.getElementById('close-tag-filter-modal'),
    cancelTagFilterBtn: document.getElementById('cancel-tag-filter-btn'),
    // Tag select modal (per-card)
    tagSelectModal: document.getElementById('tag-select-modal'),
    tagSelectList: document.getElementById('tag-select-list'),
    closeTagSelectBtn: document.getElementById('close-tag-select-modal'),
    cancelTagSelectBtn: document.getElementById('cancel-tag-select-btn'),
    closeEditBookmarkBtn: document.getElementById('close-edit-bookmark-btn'),
    cancelEditBookmarkBtn: document.getElementById('cancel-edit-bookmark-btn'),
    saveEditBookmarkBtn: document.getElementById('save-edit-bookmark-btn'),
    editBookmarkTitleInput: document.getElementById('edit-bookmark-title-input'),
    editBookmarkUrlInput: document.getElementById('edit-bookmark-url-input'),
    editBookmarkTagsInput: document.getElementById('edit-bookmark-tags-input'),
    editReminderModal: document.getElementById('edit-reminder-modal'),
    closeEditReminderBtn: document.getElementById('close-edit-reminder-btn'),
    cancelEditReminderBtn: document.getElementById('cancel-edit-reminder-btn'),
    saveEditReminderBtn: document.getElementById('save-edit-reminder-btn'),
    editReminderServiceInput: document.getElementById('edit-reminder-service-input'),
    editReminderContentInput: document.getElementById('edit-reminder-content-input'),
    editReminderTimeInput: document.getElementById('edit-reminder-time-input'),
    editReminderDaysInput: document.getElementById('edit-reminder-days-input'),
    editReminderRecurringCheckbox: document.getElementById('edit-reminder-recurring-checkbox'),
    editReminderCycleModeSelect: document.getElementById('edit-reminder-cycle-mode'),
    editReminderCycleDaysInput: document.getElementById('edit-reminder-cycle-days'),
    editReminderCycleDaysGroup: document.getElementById('edit-reminder-cycle-days-group'),

    // Services
    servicesModal: document.getElementById('services-modal'),
    serviceList: document.getElementById('service-list'),
    refreshServicesBtn: document.getElementById('refresh-services-btn'),
    closeServicesModalBtn: document.getElementById('close-services-modal-btn'),

    // Toast
    messageToast: document.getElementById('message-toast')
  };

  // ============================================================================
  // æ ‡ç­¾ç¼–è¾‘å™¨ç±»
  // ============================================================================
  class TagsEditor {
    constructor(inputId, containerId) {
      this.input = document.getElementById(inputId);
      this.container = document.getElementById(containerId);
      this.tags = [];
      
      // æŒ‰å›è½¦æ·»åŠ æ ‡ç­¾
      this.input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          this.addTag();
        }
      });
      
      // å¤±ç„¦æ—¶æ·»åŠ æ ‡ç­¾
      this.input.addEventListener('blur', () => {
        if (this.input.value.trim()) {
          this.addTag();
        }
      });
    }
    
    addTag() {
      const value = this.input.value.trim();
      if (!value) return;
      
      // é¿å…é‡å¤
      if (this.tags.includes(value)) {
        this.input.value = '';
        return;
      }
      
      this.tags.push(value);
      this.input.value = '';
      this.render();
    }
    
    removeTag(index) {
      this.tags.splice(index, 1);
      this.render();
    }
    
    render() {
      this.container.innerHTML = this.tags.map((tag, idx) => `
        <div class="tag-item">
          <span class="tag-item-text">${escapeHtml(tag)}</span>
          <button type="button" class="tag-item-delete" data-index="${idx}">Ã—</button>
        </div>
      `).join('');
      
      // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
      this.container.querySelectorAll('.tag-item-delete').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          this.removeTag(parseInt(btn.dataset.index));
        });
      });
    }
    
    getTags() {
      return this.tags;
    }
    
    setTags(tags) {
      this.tags = Array.isArray(tags) ? [...tags] : [];
      this.render();
    }
    
    reset() {
      this.tags = [];
      this.input.value = '';
      this.render();
    }
  }

  // ============================================================================
  // å·¥å…·å‡½æ•°
  // ============================================================================

  /**
   * æ ¼å¼åŒ–æ—¥æœŸ
   */
  function formatDate(dateString) {
    if (!dateString) return '';
    try {
      return new Date(dateString).toLocaleString('zh-CN');
    } catch {
      return dateString;
    }
  }

  /**
   * è½¬ä¹‰ HTML ç‰¹æ®Šå­—ç¬¦
   */
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  /**
   * è¿”å›æœ¬åœ°ï¼ˆæµè§ˆå™¨æ—¶åŒºï¼‰ISO æ—¥æœŸå­—ç¬¦ä¸² YYYY-MM-DD
   */
  function localIsoDate() {
    const d = new Date();
    const tzOffset = d.getTimezoneOffset() * 60000; // æ¯«ç§’
    return new Date(Date.now() - tzOffset).toISOString().slice(0,10);
  }

  // è¿”å›ç›¸å¯¹äºä»Šå¤©çš„ ISO æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆoffset å¤©ï¼‰
  function isoDateOffset(offsetDays) {
    const tzOffset = new Date().getTimezoneOffset() * 60000;
    return new Date(Date.now() - tzOffset + offsetDays * 86400000).toISOString().slice(0,10);
  }

  /**
   * æ£€æŸ¥å¹¶æç¤ºï¼š
   * - æ™®é€šæé†’å·²è¿‡æœŸï¼ˆdue_time < ä»Šå¤© ä¸” æœªå¤„ç†ï¼‰
   * - æ¯æ—¥æé†’æ˜¨æ—¥æœªå®Œæˆï¼ˆcreated_at <= æ˜¨å¤© ä¸” last_completed_date != æ˜¨å¤©ï¼‰
   */
  function checkReminderAlerts() {
    const today = isoDateOffset(0);
    const yesterday = isoDateOffset(-1);

    const expired = AppState.reminders.filter(r => {
        // è¿‡æ»¤æ‰å·²å¤„ç†çš„ä¸€æ¬¡æ€§ä»»åŠ¡
        if (!r.recurring && r.processed) return false;
        
        // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
        if (r.due_time && r.due_time < today) {
            // å¯¹äºå¾ªç¯ä»»åŠ¡ï¼Œå¦‚æœä»Šå¤©è¿˜æ²¡åšï¼ˆlast_completed_date != todayï¼‰ï¼Œä¹Ÿç®—è¿‡æœŸæé†’
            if (r.recurring) {
                return r.last_completed_date !== today;
            }
            return true;
        }
        return false;
    });

    // æ¯æ—¥æé†’é€»è¾‘ç°åœ¨ç»Ÿä¸€å¹¶å…¥ recurring='daily'ï¼Œä¸Šé¢çš„é€»è¾‘å·²ç»è¦†ç›–
    // ä½†ä¸ºäº†å…¼å®¹æ—§æ•°æ®æˆ–å¼ºè°ƒæ¯æ—¥æ‰“å¡ï¼Œæˆ‘ä»¬å¯ä»¥å•ç‹¬ç»Ÿè®¡ä¸€ä¸‹ cycle_mode='daily' çš„è¿‡æœŸ
    const missedDaily = expired.filter(r => r.cycle_mode === 'daily');

    const parts = [];
    if (expired.length) parts.push(`æœ‰ ${expired.length} ä¸ªå·²è¿‡æœŸæé†’`);

    if (parts.length) {
      showMessage(parts.join('ï¼Œ') + 'ã€‚è¯·å‰å¾€æé†’é¡µæŸ¥çœ‹ã€‚', 'warning');
    }
    // æ›´æ–°ç»Ÿè®¡å¡ä¸Šçš„æç¤ºï¼ˆå¡ç‰‡å³ä¸Šè§’ metric-hintï¼‰
    updateReminderCardAlert(expired.length, missedDaily.length);
  }

  function updateReminderCardAlert(expiredCount, missedCount) {
    const card = DOM.statRemindersCard;
    const hint = DOM.statRemindersHintEl;
    if (!card || !hint) return;

    if (expiredCount || missedCount) {
      card.classList.add('alert');
      const parts = [];
      if (expiredCount) parts.push(`${expiredCount} è¿‡æœŸ`);
      if (missedCount) parts.push(`${missedCount} æ˜¨æ—¥æœªå®Œæˆ`);
      hint.textContent = parts.join(' / ');
      hint.classList.add('alert');
    } else {
      card.classList.remove('alert');
      hint.textContent = 'æœªå¤„ç†';
      hint.classList.remove('alert');
    }
  }

  /**
   * æ˜¾ç¤ºæ¶ˆæ¯æç¤º
   */
  function showMessage(text, type = 'info') {
    DOM.messageToast.textContent = text;
    DOM.messageToast.className = `toast ${type}`;
    requestAnimationFrame(() => DOM.messageToast.classList.add('show'));
    setTimeout(() => DOM.messageToast.classList.remove('show'), 3000);
  }

  /**
   * æ‰“å¼€æ¨¡æ€æ¡†
   */
  function openModal(modalEl) {
    if (!modalEl) return;
    // ç§»é™¤å¯èƒ½æ®‹ç•™çš„ closing çŠ¶æ€
    modalEl.classList.remove('closing');
    modalEl.style.display = 'flex';

    // é‡ç½®æ»šåŠ¨ä½ç½®
    const body = modalEl.querySelector('.modal-body');
    if (body) {
      body.scrollTop = 0;
    }

    // å¼ºåˆ¶é‡ç»˜ä»¥è§¦å‘ CSS è¿‡æ¸¡
    modalEl.offsetHeight; 
    modalEl.classList.add('show');
  }

  /**
   * å…³é—­æ¨¡æ€æ¡†
   */
  function closeModal(modalEl) {
    if (!modalEl) return;
    // æ·»åŠ  closing ç±»è§¦å‘å…³é—­åŠ¨ç”»
    modalEl.classList.remove('show');
    
    // ç­‰å¾…è¿‡æ¸¡ç»“æŸåéšè— display
    const onTransitionEnd = (e) => {
      if (e.target !== modalEl) return;
      modalEl.removeEventListener('transitionend', onTransitionEnd);
      if (!modalEl.classList.contains('show')) {
        modalEl.style.display = 'none';
      }
    };
    modalEl.addEventListener('transitionend', onTransitionEnd);
    
    // å…œåº•ï¼šå¦‚æœ transitionend æœªè§¦å‘ï¼ˆä¾‹å¦‚å…ƒç´ ä¸å¯è§ï¼‰ï¼Œå¼ºåˆ¶éšè—
    setTimeout(() => {
      if (!modalEl.classList.contains('show')) {
        modalEl.style.display = 'none';
      }
    }, 250);
  }

  // ============================================================================
  // ä¹¦ç­¾ï¼šCRUD ä¸æ¸²æŸ“
  // ============================================================================
  async function fetchBookmarks() {
    try {
      AppState.bookmarks = await ApiService.bookmarks.getAll();
      renderBookmarks();
    } catch (error) {
      showMessage('åŠ è½½ä¹¦ç­¾å¤±è´¥', 'error');
      console.error('fetchBookmarks:', error);
    }
  }

  function openBookmarkForm() {
    DOM.bookmarkTitleInput.value = '';
    DOM.bookmarkUrlInput.value = '';
    DOM.bookmarkDescriptionInput.value = '';
    DOM.bookmarkTagsInput.value = '';
    // reset tags editor instance so tags from previous entry do not persist
    if (typeof bookmarkTagsEditor !== 'undefined' && bookmarkTagsEditor && typeof bookmarkTagsEditor.reset === 'function') {
      bookmarkTagsEditor.reset();
    }
    openModal(DOM.bookmarkModal);
  }

  function closeBookmarkForm() {
    closeModal(DOM.bookmarkModal);
  }

  async function addBookmark() {
    const title = DOM.bookmarkTitleInput.value.trim();
    const url = DOM.bookmarkUrlInput.value.trim();
    const description = DOM.bookmarkDescriptionInput.value.trim();
    const tagsRaw = DOM.bookmarkTagsInput.value.trim();
    if (!title || !url) {
      showMessage('è¯·è¾“å…¥åç§°ä¸ç½‘å€', 'warning');
      return;
    }
    const tags = tagsRaw ? tagsRaw.split(',').map(t => t.trim()).filter(Boolean) : [];
    try {
      await ApiService.bookmarks.create({ title, url, description, tags });
      showMessage('ä¹¦ç­¾å·²æ·»åŠ ', 'success');
      closeBookmarkForm();
      await fetchBookmarks();
    } catch (error) {
      showMessage('æ·»åŠ å¤±è´¥', 'error');
      console.error('addBookmark:', error);
    }
  }

  function openEditBookmark(id) {
    const bm = AppState.bookmarks.find(b => b.id == id);
    if (!bm) return;
    AppState.editingBookmarkId = id;
    DOM.editBookmarkTitleInput.value = bm.title;
    DOM.editBookmarkUrlInput.value = bm.url;
    DOM.editBookmarkDescriptionInput.value = bm.description || '';
    // æ ‡ç­¾ç”±ç¼–è¾‘å™¨ç®¡ç†ï¼Œè¿™é‡Œä¸è®¾ç½®è¾“å…¥æ¡†çš„å€¼
    openModal(DOM.editBookmarkModal);
  }

  function closeEditBookmark() {
    closeModal(DOM.editBookmarkModal);
    AppState.editingBookmarkId = null;
  }

  async function saveEditBookmark() {
    if (!AppState.editingBookmarkId) return;
    const title = DOM.editBookmarkTitleInput.value.trim();
    const url = DOM.editBookmarkUrlInput.value.trim();
    const tagsRaw = DOM.editBookmarkTagsInput.value.trim();
    const tags = tagsRaw ? tagsRaw.split(',').map(t => t.trim()).filter(Boolean) : [];
    if (!title || !url) {
      showMessage('åç§°ä¸ç½‘å€ä¸èƒ½ä¸ºç©º', 'warning');
      return;
    }
    try {
      const description = DOM.editBookmarkDescriptionInput.value.trim();
      await ApiService.bookmarks.update(AppState.editingBookmarkId, { title, url, tags, description });
      showMessage('ä¹¦ç­¾å·²æ›´æ–°', 'success');
      closeEditBookmark();
      await fetchBookmarks();
    } catch (error) {
      showMessage('ä¿å­˜å¤±è´¥', 'error');
      console.error('saveEditBookmark:', error);
    }
  }

  async function deleteBookmark(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¹¦ç­¾å—ï¼Ÿ')) return;
    try {
      await ApiService.bookmarks.delete(id);
      showMessage('ä¹¦ç­¾å·²åˆ é™¤', 'success');
      await fetchBookmarks();
    } catch (error) {
      showMessage('åˆ é™¤å¤±è´¥', 'error');
      console.error('deleteBookmark:', error);
    }
  }

  function normalizeUrl(url) {
    if (!/^https?:\/\//i.test(url)) return 'https://' + url;
    return url;
  }

  function renderBookmarks() {
    const total = AppState.bookmarks.length;

    if (DOM.statBookmarks) DOM.statBookmarks.textContent = String(total);
    if (DOM.bookmarkCountBadge) DOM.bookmarkCountBadge.textContent = `${total} é¡¹`;

    if (total === 0) {
      DOM.bookmarkGrid.innerHTML = `
        <div class="empty-state empty-centered grid-span-full">
          <p class="empty-text">æš‚æ— ä¹¦ç­¾</p>
        </div>`;
      return;
    }

    // åº”ç”¨æ ‡ç­¾è¿‡æ»¤ï¼ˆå¦‚æœæœ‰ï¼‰ - æ”¯æŒå¤šé€‰æ ‡ç­¾ï¼ˆæ‰€æœ‰é€‰ä¸­æ ‡ç­¾éƒ½å¿…é¡»å­˜åœ¨ï¼‰
    const filterTags = (Array.isArray(AppState.bookmarkFilterTags) ? AppState.bookmarkFilterTags : []).filter(Boolean);
    const items = (filterTags.length > 0) ? AppState.bookmarks.filter(bm => {
      const tags = Array.isArray(bm.tags) ? bm.tags : (typeof bm.tags === 'string' ? bm.tags.split(',').map(t=>t.trim()).filter(Boolean) : []);
      // è¦æ±‚ bookmark å¿…é¡»åŒ…å«æ‰€æœ‰é€‰ä¸­çš„æ ‡ç­¾ï¼ˆAND é€»è¾‘ï¼‰
      return filterTags.every(ft => tags.includes(ft));
    }) : [...AppState.bookmarks];

    const html = items.map(bm => {
      const tags = Array.isArray(bm.tags) ? bm.tags : (typeof bm.tags === 'string' ? bm.tags.split(',').map(t=>t.trim()).filter(Boolean) : []);
      const tagCount = tags.length;
      const tagHtml = ''; // per-tag badges are removed from card view; use the tag button instead
      const urlNorm = normalizeUrl(escapeHtml(bm.url));
      return `
      <div class="bookmark-item" data-id="${bm.id}" data-url="${urlNorm}" data-title="${escapeHtml(bm.title)}" data-tags="${tags.join(', ')}" tabindex="0" role="link" aria-label="${escapeHtml(bm.title)}: ${escapeHtml(bm.url)}">
        <div class="bookmark-block">
          <img class="bookmark-favicon" src="https://www.google.com/s2/favicons?domain=${encodeURIComponent(bm.url)}&sz=64" alt="" onerror="this.style.display='none'" />
          <div class="bookmark-block-content">
            <div class="bookmark-block-title">${escapeHtml(bm.title)}</div>
            ${bm.description ? `<div class="bookmark-block-desc">${escapeHtml(bm.description)}</div>` : ''}
          </div>
          <div class="bookmark-block-actions">
            ${tagCount ? ('<button class="btn btn-ghost btn-small tag-bookmark-btn" type="button" data-tags="' + tags.join(', ') + '">æ ‡ç­¾</button>') : ''}
            <button class="btn btn-secondary btn-small edit-bookmark-btn" data-id="${bm.id}" type="button">ç¼–è¾‘</button>
            <button class="btn btn-danger btn-small delete-bookmark-btn" data-id="${bm.id}" type="button">åˆ é™¤</button>
          </div>
        </div>
      </div>
      `;
    }).join('');

    const activeTags = Array.isArray(AppState.bookmarkFilterTags) ? AppState.bookmarkFilterTags : [];
    const filterBarHtml = activeTags.length ? `<div class="bookmark-filter">æ˜¾ç¤ºæ ‡ç­¾ï¼š${activeTags.map(t=>`<span class="tag-badge tag-filter-item" data-tag="${escapeHtml(t)}">${escapeHtml(t)} <button type="button" class="tag-item-delete tag-filter-remove" aria-label="åˆ é™¤ç­›é€‰" data-tag="${escapeHtml(t)}">Ã—</button></span>`).join(' ')}</div>` : '';

    // render cards into the grid
    DOM.bookmarkGrid.innerHTML = html;

    // ensure the filter bar sits above the grid (direct child of .mini-body) so it appears under the header
    const miniBody = DOM.bookmarkGrid.parentElement;
    const existingFilterBar = miniBody.querySelector('.bookmark-filter');
    if (existingFilterBar) existingFilterBar.remove();
    if (filterBarHtml) {
      miniBody.insertAdjacentHTML('afterbegin', filterBarHtml);

      // per-tag remove handlers are bound separately below (handles multiple tags)
    }

    // å¡ç‰‡ç‚¹å‡»/é”®ç›˜å¯¼èˆªï¼šæ•´ä½“å—ï¼ˆç‚¹å‡»éæŒ‰é’®åŒºåŸŸï¼‰å¯¼èˆªï¼›æŒ‰é’®ä¸æ ‡ç­¾æœ‰ç‹¬ç«‹è¡Œä¸º
    DOM.bookmarkGrid.querySelectorAll('.bookmark-item').forEach(item => {
      item.addEventListener('click', (e) => {
        if (e.target.closest('button') || e.target.classList.contains('tag-badge')) return; // ç‚¹å‡»çš„æ˜¯æŒ‰é’®/æ ‡ç­¾ï¼Œäº¤ç”±å®ƒä»¬å¤„ç†
        const url = item.dataset.url;
        if (!url) return;
        // é»˜è®¤åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€
        window.open(url, '_blank');
      });
      item.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          const url = item.dataset.url;
          if (url) window.open(url, '_blank');
        }
      });
    });

    // å¡ç‰‡ä¸Šä¸å†æ˜¾ç¤ºå•ç‹¬çš„æ ‡ç­¾å¾½ç« ï¼Œæ”¹ä¸ºå³ä¸Šè§’çš„æ ‡ç­¾æŒ‰é”®æ‰“å¼€æ ‡ç­¾é€‰æ‹©å™¨ã€‚

    // ç»‘å®šè¿‡æ»¤æ¡ä¸Šçš„åˆ é™¤ï¼ˆç§»é™¤å•ä¸ªç­›é€‰æ ‡ç­¾ï¼‰æŒ‰é’®
    miniBody.querySelectorAll('.tag-filter-remove').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const tag = btn.dataset.tag;
        if (!tag) return;
        AppState.bookmarkFilterTags = (Array.isArray(AppState.bookmarkFilterTags) ? AppState.bookmarkFilterTags : []).filter(t => t !== tag);
        renderBookmarks();
      });
    });

    // ç»‘å®šç¼–è¾‘æŒ‰é’®
    DOM.bookmarkGrid.querySelectorAll('.edit-bookmark-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        e.preventDefault();
        e.stopPropagation();
        openEditBookmark(e.target.dataset.id);
      });
    });

    // ç»‘å®šåˆ é™¤æŒ‰é’®
    DOM.bookmarkGrid.querySelectorAll('.delete-bookmark-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        e.preventDefault();
        e.stopPropagation();
        deleteBookmark(e.target.dataset.id);
      });
    });

    // ç»‘å®šæ ‡ç­¾æŒ‰é’®ï¼ˆå¡ç‰‡å³ä¸Šè§’ï¼‰
    DOM.bookmarkGrid.querySelectorAll('.tag-bookmark-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const item = btn.closest('.bookmark-item');
        if (!item) return;
        openTagSelector(item);
      });
    });
  } 

  // å…¨å±€ï¼šæ‰“å¼€æ ‡ç­¾ç­›é€‰æ¨¡æ€ï¼ˆèšåˆæ‰€æœ‰ä¹¦ç­¾çš„æ ‡ç­¾ï¼‰
  function openTagFilter() {
    const tagsSet = new Set();
    AppState.bookmarks.forEach(bm => {
      const tags = Array.isArray(bm.tags) ? bm.tags : (typeof bm.tags === 'string' ? bm.tags.split(',').map(t => t.trim()).filter(Boolean) : []);
      tags.forEach(t => tagsSet.add(t));
    });
    if (tagsSet.size === 0) {
      showMessage('å½“å‰æ²¡æœ‰æ ‡ç­¾å¯ç­›é€‰', 'info');
      return;
    }
    const listEl = DOM.tagFilterList;
    const activeTags = Array.isArray(AppState.bookmarkFilterTags) ? AppState.bookmarkFilterTags : [];
    listEl.innerHTML = Array.from(tagsSet).map(t => ` <button type="button" class="btn btn-ghost tag-filter-item ${activeTags.includes(t)?'active':''}" data-tag="${escapeHtml(t)}">${escapeHtml(t)}</button>`).join('');
    openModal(DOM.tagFilterModal);

    // bind clicks: toggle selection (multi-select)
    listEl.querySelectorAll('.tag-filter-item').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const tag = btn.dataset.tag;
        if (!tag) return;
        const curr = Array.isArray(AppState.bookmarkFilterTags) ? AppState.bookmarkFilterTags : [];
        if (curr.includes(tag)) {
          AppState.bookmarkFilterTags = curr.filter(t => t !== tag);
          btn.classList.remove('active');
        } else {
          AppState.bookmarkFilterTags = [...curr, tag];
          btn.classList.add('active');
        }
        renderBookmarks();
      });
    });
  }

  // ============================================================================
  // æ¨¡æ€æ¡†äº¤äº’
  // ============================================================================

  /**
   * æ‰“å¼€å¾…åŠæ·»åŠ è¡¨å•
   */
  function openTodoForm() {
    openModal(DOM.addTodoModal);
    // reset details and focus
    DOM.todoDetailsInput.value = '';
    setTimeout(() => DOM.todoInput.focus(), 100);
  }

  /**
   * å…³é—­å¾…åŠæ·»åŠ è¡¨å•
   */
  function closeTodoForm() {
    closeModal(DOM.addTodoModal);
    DOM.todoInput.value = '';
    DOM.todoPrioritySelect.value = 'medium';
    DOM.todoDetailsInput.value = '';
  }

  /**
   * æ‰“å¼€å¾…åŠç¼–è¾‘è¡¨å•
   */
  function openEditTodo(id) {
    const todo = AppState.todos.find(t => t.id == id);
    if (!todo) return;

    AppState.editingTodoId = id;
    DOM.editTodoInput.value = todo.title;
    DOM.editTodoPriority.value = todo.priority || 'medium';
    DOM.editTodoDetails.value = todo.details || '';
    openModal(DOM.editTodoModal);
  }

  // ç‚¹å‡»å¡ç‰‡çš„æ ‡ç­¾é€‰æ‹©å™¨ï¼ˆæ˜¾ç¤ºè¯¥å¡ç‰‡çš„æ ‡ç­¾ï¼Œç‚¹å‡»æ ‡ç­¾åˆ™è¿›è¡Œæ ‡ç­¾ç­›é€‰ï¼‰
  function openTagSelector(source) {
    let tags = [];
    if (!source) return showMessage('è¯¥ä¹¦ç­¾æ²¡æœ‰æ ‡ç­¾', 'info');
    if (source instanceof Element) {
      const tagsStr = source.dataset.tags || '';
      tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(Boolean) : [];
    } else if (Array.isArray(source)) {
      tags = source;
    } else if (typeof source === 'string') {
      tags = source.split(',').map(t => t.trim()).filter(Boolean);
    }

    if (!tags.length) {
      showMessage('è¯¥ä¹¦ç­¾æ²¡æœ‰æ ‡ç­¾', 'info');
      return;
    }

    const list = document.getElementById('tag-select-list');
    const activeTags = Array.isArray(AppState.bookmarkFilterTags) ? AppState.bookmarkFilterTags : [];
    list.innerHTML = `<div class="form-note">é€‰æ‹©æ ‡ç­¾ä»¥ç­›é€‰ä¹¦ç­¾</div>` + tags.map(t => `<button type="button" class="btn btn-ghost tag-select-item ${activeTags.includes(t) ? 'active' : ''}" data-tag="${escapeHtml(t)}">${escapeHtml(t)}</button>`).join('');
    openModal(document.getElementById('tag-select-modal'));

    // bind clicks: toggle selection (multi-select), immediate apply
    list.querySelectorAll('.tag-select-item').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const tag = btn.dataset.tag;
        if (!tag) return;
        const curr = Array.isArray(AppState.bookmarkFilterTags) ? AppState.bookmarkFilterTags : [];
        if (curr.includes(tag)) {
          AppState.bookmarkFilterTags = curr.filter(t => t !== tag);
          btn.classList.remove('active');
        } else {
          AppState.bookmarkFilterTags = [...curr, tag];
          btn.classList.add('active');
        }
        renderBookmarks();
      });
    });
  }

  function closeTagSelector() {
    closeModal(document.getElementById('tag-select-modal'));
  }

  /**
   * å…³é—­å¾…åŠç¼–è¾‘è¡¨å•
   */
  function closeEditTodo() {
    closeModal(DOM.editTodoModal);
    AppState.editingTodoId = null;
    DOM.editTodoInput.value = '';
    DOM.editTodoDetails.value = '';
  }

  /**
   * æ‰“å¼€æé†’æ·»åŠ è¡¨å•
   */
  function openReminderForm() {
    // é‡ç½®å¹¶æ‰“å¼€è¡¨å•
    DOM.reminderTimeInput.value = '';
    DOM.reminderDaysInput.value = '30';
    DOM.reminderRecurringCheckbox.checked = false;
    DOM.reminderCycleModeSelect.value = 'days';
    DOM.reminderCycleDaysInput.value = '';
    // ensure advance & due & recurring group visibility defaults
    document.getElementById('reminder-advance-group').style.display = '';
    document.getElementById('reminder-due-group').style.display = '';
    document.getElementById('reminder-recurring-group').style.display = '';
    document.getElementById('reminder-cycle-group').style.display = 'none';
    document.getElementById('reminder-cycle-days-group').style.display = 'none';
    openModal(DOM.reminderModal);
  }

  /**
   * å…³é—­æé†’æ·»åŠ è¡¨å•
   */
  function closeReminderForm() {
    closeModal(DOM.reminderModal);
    DOM.reminderServiceInput.value = '';
    DOM.reminderContentInput.value = '';
    DOM.reminderTimeInput.value = '';
    DOM.reminderDaysInput.value = '30';
    DOM.reminderRecurringCheckbox.checked = false;
    DOM.reminderCycleDaysInput.value = '30';
    document.getElementById('reminder-advance-group').style.display = '';
    document.getElementById('reminder-due-group').style.display = '';
    document.getElementById('reminder-recurring-group').style.display = '';
    document.getElementById('reminder-cycle-group').style.display = 'none';
  }

  // ============================================================================
  // å¾…åŠäº‹é¡¹æ“ä½œ
  // ============================================================================

  /**
   * åŠ è½½å¾…åŠåˆ—è¡¨
   */
  async function fetchTodos() {
    try {
      AppState.todos = await ApiService.todos.getAll();
      renderTodos();
    } catch (error) {
      showMessage('åŠ è½½å¾…åŠäº‹é¡¹å¤±è´¥', 'error');
      console.error('fetchTodos:', error);
    }
  }

  /**
   * æ·»åŠ å¾…åŠ
   */
  async function addTodo() {
    const title = DOM.todoInput.value.trim();
    if (!title) {
      showMessage('è¯·è¾“å…¥å¾…åŠäº‹é¡¹å†…å®¹', 'warning');
      return;
    }

    const priority = DOM.todoPrioritySelect.value;
    const details = DOM.todoDetailsInput.value.trim();
    try {
      await ApiService.todos.create({ title, priority, details });
      showMessage('å¾…åŠäº‹é¡¹å·²æ·»åŠ ', 'success');
      closeTodoForm();
      await fetchTodos();
    } catch (error) {
      showMessage('æ·»åŠ å¤±è´¥', 'error');
      console.error('addTodo:', error);
    }
  }

  /**
   * åˆ‡æ¢å¾…åŠå®ŒæˆçŠ¶æ€
   */
  async function toggleTodo(id) {
    const todo = AppState.todos.find(t => t.id == id);
    if (!todo) return;

    const newCompleted = !todo.completed;
    const completedAt = newCompleted ? new Date().toISOString() : null;

    try {
      await ApiService.todos.update(id, {
        title: todo.title,
        completed: newCompleted,
        completed_at: completedAt,
        priority: todo.priority || 'medium'
      });
      await fetchTodos();
    } catch (error) {
      showMessage('æ›´æ–°å¤±è´¥', 'error');
      console.error('toggleTodo:', error);
    }
  }

  /**
   * ä¿å­˜å¾…åŠç¼–è¾‘
   */
  async function saveEditTodo() {
    if (!AppState.editingTodoId) return;

    const title = DOM.editTodoInput.value.trim();
    if (!title) {
      showMessage('å¾…åŠäº‹é¡¹ä¸èƒ½ä¸ºç©º', 'warning');
      return;
    }

    const todo = AppState.todos.find(t => t.id == AppState.editingTodoId);
    const priority = DOM.editTodoPriority.value;
    const details = DOM.editTodoDetails.value.trim();

    try {
      await ApiService.todos.update(AppState.editingTodoId, {
        title,
        completed: todo.completed,
        priority,
        details
      });
      showMessage('å¾…åŠäº‹é¡¹å·²æ›´æ–°', 'success');
      closeEditTodo();
      await fetchTodos();
    } catch (error) {
      showMessage('ä¿å­˜å¤±è´¥', 'error');
      console.error('saveEditTodo:', error);
    }
  }

  /**
   * åˆ é™¤å¾…åŠ
   */
  async function deleteTodo(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¾…åŠäº‹é¡¹å—ï¼Ÿ')) return;

    try {
      await ApiService.todos.delete(id);
      showMessage('å¾…åŠäº‹é¡¹å·²åˆ é™¤', 'success');
      await fetchTodos();
    } catch (error) {
      showMessage('åˆ é™¤å¤±è´¥', 'error');
      console.error('deleteTodo:', error);
    }
  }

  /**
   * æ¸²æŸ“å¾…åŠåˆ—è¡¨
   */
  function renderTodos() {
    // æ ¹æ®è¿‡æ»¤æ¡ä»¶ç­›é€‰å¾…åŠ
    let filteredTodos;
    if (AppState.todoFilterPriority === 'completed') {
      // åªæ˜¾ç¤ºå·²å®Œæˆçš„
      filteredTodos = AppState.todos.filter(todo => todo.completed);
    } else if (AppState.todoFilterPriority === 'all') {
      // æ˜¾ç¤ºæ‰€æœ‰æœªå®Œæˆçš„
      filteredTodos = AppState.todos.filter(todo => !todo.completed);
    } else {
      // æ˜¾ç¤ºç‰¹å®šä¼˜å…ˆçº§çš„æœªå®Œæˆå¾…åŠ
      filteredTodos = AppState.todos.filter(todo => !todo.completed && todo.priority === AppState.todoFilterPriority);
    }
    
    if (DOM.statTodos) DOM.statTodos.textContent = `${AppState.todos.filter(t => !t.completed).length}`;

    if (filteredTodos.length === 0) {
      const filterText = AppState.todoFilterPriority === 'completed' ? 'å·²å®Œæˆçš„' : (AppState.todoFilterPriority === 'all' ? '' : 'ç¬¦åˆæ¡ä»¶çš„');
      DOM.todoList.innerHTML = `<div class="empty-state empty-centered"><p class="empty-text">æš‚æ— ${filterText}å¾…åŠäº‹é¡¹</p></div>`;
      return;
    }

    // æŒ‰ä¼˜å…ˆçº§å’Œåˆ›å»ºæ—¶é—´æ’åºï¼šé«˜ > ä¸­ > ä½ï¼ŒåŒä¼˜å…ˆçº§æŒ‰åˆ›å»ºæ—¶é—´å‡åºï¼ˆæ—©çš„åœ¨å‰ï¼‰
    const priorityOrder = { high: 0, medium: 1, low: 2 };
    const sortedTodos = [...filteredTodos].sort((a, b) => {
      const aPriority = priorityOrder[a.priority] ?? 1;
      const bPriority = priorityOrder[b.priority] ?? 1;
      if (aPriority !== bPriority) {
        return aPriority - bPriority;
      }
      // åŒä¼˜å…ˆçº§ï¼ŒæŒ‰åˆ›å»ºæ—¶é—´å‡åºï¼ˆè¶Šæ—©åˆ›å»ºçš„è¶Šé å‰ï¼‰
      return new Date(a.created_at) - new Date(b.created_at);
    });

    const priorityText = { high: 'é«˜', medium: 'ä¸­', low: 'ä½' };
    const html = sortedTodos.map(todo => {
      const badge = todo.priority
        ? `<span class="priority-badge ${todo.priority}">${priorityText[todo.priority]}</span>`
        : '';
      
      // æ ¹æ®å®ŒæˆçŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æŒ‰é’®æ–‡å­—
      const completeBtnText = todo.completed ? 'å¾…åŠ' : 'å®Œæˆ';

      // æ˜¾ç¤ºæ—¶é—´ä¿¡æ¯ï¼šå·²å®Œæˆæ˜¾ç¤ºåˆ›å»ºå’Œå®Œæˆæ—¶é—´ï¼Œæœªå®Œæˆåªæ˜¾ç¤ºåˆ›å»ºæ—¶é—´
      let timeInfo;
      if (todo.completed && todo.completed_at) {
        timeInfo = `åˆ›å»ºäº ${formatDate(todo.created_at)}<br>å®Œæˆäº ${formatDate(todo.completed_at)}`;
      } else {
        timeInfo = `åˆ›å»ºäº ${formatDate(todo.created_at)}`;
      }

      return `
        <div class="todo-item ${todo.completed ? 'completed' : ''}" data-id="${todo.id}">
          <div class="todo-header">
            <div class="todo-title-wrap">
              <span class="todo-title">${escapeHtml(todo.title)}</span>
              ${badge}
            </div>
            <div class="todo-actions">
              <button class="btn btn-secondary btn-small complete-todo-btn" data-id="${todo.id}">${completeBtnText}</button>
              <button class="btn btn-secondary btn-small edit-todo-btn" data-id="${todo.id}">ç¼–è¾‘</button>
              <button class="btn btn-danger btn-small delete-todo-btn" data-id="${todo.id}">åˆ é™¤</button>
            </div>
          </div>
          ${todo.details ? `<div class="todo-details">${escapeHtml(todo.details)}</div>` : ''}
          <div class="todo-meta">${timeInfo}</div>
        </div>
      `;
    }).join('');

    DOM.todoList.innerHTML = `<div class="todo-list">${html}</div>`;

    // ç»‘å®šäº‹ä»¶
    DOM.todoList.querySelectorAll('.complete-todo-btn').forEach(btn => {
      btn.addEventListener('click', e => toggleTodo(e.target.dataset.id));
    });
    DOM.todoList.querySelectorAll('.edit-todo-btn').forEach(btn => {
      btn.addEventListener('click', e => openEditTodo(e.target.dataset.id));
    });
    DOM.todoList.querySelectorAll('.delete-todo-btn').forEach(btn => {
      btn.addEventListener('click', e => deleteTodo(e.target.dataset.id));
    });
  }

  // ============================================================================
  // æé†’äº‹é¡¹æ“ä½œ
  // ============================================================================

  /**
   * åŠ è½½æé†’åˆ—è¡¨
   */
  async function fetchReminders() {
    try {
      AppState.reminders = await ApiService.reminders.getAll();
      renderReminders();
      // æ£€æŸ¥å¹¶æç¤ºè¿‡æœŸæˆ–æ˜¨æ—¥æœªå®Œæˆçš„æ¯æ—¥æé†’
      checkReminderAlerts();
    } catch (error) {
      showMessage('åŠ è½½æé†’äº‹é¡¹å¤±è´¥', 'error');
      console.error('fetchReminders:', error);
    }
  }

  /**
   * æ·»åŠ æé†’
   */
  async function addReminder() {
    const service = DOM.reminderServiceInput.value.trim();
    const content = DOM.reminderContentInput.value.trim();
    const dueTime = DOM.reminderTimeInput.value;
    const advanceDays = parseInt(DOM.reminderDaysInput.value) || 0;
    const recurring = DOM.reminderRecurringCheckbox ? DOM.reminderRecurringCheckbox.checked : false;
    const cycleMode = DOM.reminderCycleModeSelect ? DOM.reminderCycleModeSelect.value : null;
    const cycleDays = (cycleMode === 'days' && DOM.reminderCycleDaysInput && DOM.reminderCycleDaysInput.value) ? parseInt(DOM.reminderCycleDaysInput.value) : null;

    if (!service || !content) {
      showMessage('è¯·å¡«å†™æœåŠ¡åç§°å’Œå†…å®¹', 'warning');
      return;
    }
    
    // å¦‚æœä¸æ˜¯æ¯æ—¥å¾ªç¯ï¼Œå¿…é¡»æœ‰åˆ°æœŸæ—¶é—´
    if (!dueTime && !(recurring && cycleMode === 'daily')) {
         showMessage('è¯·é€‰æ‹©åˆ°æœŸæ—¶é—´', 'warning');
         return;
    }

    try {
      const payload = { 
          service, 
          content, 
          due_time: dueTime, 
          advance_days: advanceDays, 
          type: 'once', // å‰ç«¯ä¸å†åŒºåˆ† typeï¼Œç»Ÿä¸€ç”±åç«¯å¤„ç†
          recurring: recurring,
          cycle_mode: recurring ? cycleMode : null,
          cycle_days: (recurring && cycleMode === 'days') ? cycleDays : null
      };
      
      // æ¯æ—¥æé†’ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ²¡æœ‰é€‰æ—¶é—´ï¼Œé»˜è®¤ä»Šå¤©
      if (recurring && cycleMode === 'daily' && !dueTime) {
          payload.due_time = localIsoDate();
      }

      await ApiService.reminders.create(payload);
      
      showMessage('æé†’äº‹é¡¹å·²æ·»åŠ ', 'success');
      closeReminderForm();
      await fetchReminders();
    } catch (error) {
      showMessage('æ·»åŠ å¤±è´¥', 'error');
      console.error('addReminder:', error);
    }
  }

  /**
   * æ ‡è®°æé†’ä¸ºå·²å¤„ç†
   */
  async function markReminderProcessed(id) {
    try {
      const res = await ApiService.reminders.markProcessed(id);
      // æ”¯æŒä¸¤ç§åç«¯è¿”å›ï¼šæ—§ç‰ˆ {message,data} ä¸ æ–°ç‰ˆç›´æ¥è¿”å› reminder å¯¹è±¡
      if (res && res.message) {
        if (res.message.includes('daily')) {
          showMessage('æœ¬æ¬¡æé†’å·²å®Œæˆï¼Œå·²å®‰æ’ä¸‹æ¬¡æé†’', 'success');
        } else if (res.message.includes('recurring')) {
          const due = res.data && res.data.due_time ? (res.data.due_time.split('T')[0]) : '';
          showMessage(`å·²ç»­æœŸåˆ° ${due}`, 'success');
        } else {
          showMessage('å·²æ ‡è®°ä¸ºå¤„ç†', 'success');
        }
      } else if (res && res.type === 'daily') {
        showMessage('æœ¬æ¬¡æé†’å·²å®Œæˆï¼Œå·²å®‰æ’ä¸‹æ¬¡æé†’', 'success');
      } else if (res && res.recurring) {
        const due = res.due_time ? (res.due_time.split('T')[0]) : '';
        showMessage(`å·²ç»­æœŸåˆ° ${due}`, 'success');
      } else if (res && res.processed) {
        showMessage('å·²æ ‡è®°ä¸ºå¤„ç†', 'success');
      } else {
        showMessage('å·²æ ‡è®°ä¸ºå¤„ç†', 'success');
      }
      await fetchReminders();
    } catch (error) {
      showMessage('æ ‡è®°å¤±è´¥', 'error');
      console.error('markReminderProcessed:', error);
    }
  }

  /**
   * æ‰“å¼€ç¼–è¾‘æé†’è¡¨å•
   */
  function openEditReminder(id) {
    const reminder = AppState.reminders.find(r => r.id == id);
    if (!reminder) return;

    AppState.currentEditReminderId = id;
    DOM.editReminderServiceInput.value = reminder.service;
    DOM.editReminderContentInput.value = reminder.content;
    DOM.editReminderTimeInput.value = (reminder.due_time || '').split('T')[0];
    DOM.editReminderDaysInput.value = reminder.advance_days || 0;
    
    // ç»Ÿä¸€å¤„ç† recurring
    const isRecurring = !!reminder.recurring || reminder.type === 'daily'; // å…¼å®¹æ—§æ•°æ®
    DOM.editReminderRecurringCheckbox.checked = isRecurring;
    
    // ç»Ÿä¸€å¤„ç† cycle_mode
    let mode = reminder.cycle_mode;
    if (!mode && reminder.type === 'daily') mode = 'daily';
    if (!mode) mode = 'days'; // default
    
    DOM.editReminderCycleModeSelect.value = mode;
    DOM.editReminderCycleDaysInput.value = reminder.cycle_days || '';

    // UI æ˜¾ç¤ºæ§åˆ¶
    document.getElementById('edit-reminder-advance-group').style.display = '';
    document.getElementById('edit-reminder-due-group').style.display = '';
    document.getElementById('edit-reminder-recurring-group').style.display = '';
    
    document.getElementById('edit-reminder-cycle-group').style.display = isRecurring ? '' : 'none';
    document.getElementById('edit-reminder-cycle-days-group').style.display = (isRecurring && mode === 'days') ? '' : 'none';
    
    // Handle month_start visibility
    if (isRecurring && mode === 'month_start') {
        document.getElementById('edit-reminder-due-group').style.display = 'none';
        document.getElementById('edit-reminder-advance-group').style.display = 'none';
    }
    
    openModal(DOM.editReminderModal);
  }

  /**
   * å…³é—­ç¼–è¾‘æé†’è¡¨å•
   */
  function closeEditReminder() {
    AppState.currentEditReminderId = null;
    DOM.editReminderServiceInput.value = '';
    DOM.editReminderContentInput.value = '';
    DOM.editReminderTimeInput.value = '';
    DOM.editReminderDaysInput.value = '30';
    document.getElementById('edit-reminder-advance-group').style.display = '';
    document.getElementById('edit-reminder-due-group').style.display = '';
    closeModal(DOM.editReminderModal);
  }

  /**
   * ä¿å­˜ç¼–è¾‘æé†’
   */
  async function saveEditReminder() {
    const id = AppState.currentEditReminderId;
    if (!id) return;

    const service = DOM.editReminderServiceInput.value.trim();
    const content = DOM.editReminderContentInput.value.trim();
    const dueTime = DOM.editReminderTimeInput.value;
    const advanceDays = parseInt(DOM.editReminderDaysInput.value) || 0;
    const recurring = DOM.editReminderRecurringCheckbox ? DOM.editReminderRecurringCheckbox.checked : false;
    const cycleMode = DOM.editReminderCycleModeSelect ? DOM.editReminderCycleModeSelect.value : null;
    const cycleDays = (cycleMode === 'days' && DOM.editReminderCycleDaysInput && DOM.editReminderCycleDaysInput.value) ? parseInt(DOM.editReminderCycleDaysInput.value) : null;

    if (!service || !content) {
      showMessage('è¯·å¡«å†™æœåŠ¡åç§°å’Œå†…å®¹', 'warning');
      return;
    }
    
    if (!dueTime && !(recurring && cycleMode === 'daily')) {
         showMessage('è¯·é€‰æ‹©åˆ°æœŸæ—¶é—´', 'warning');
         return;
    }

    try {
      const payload = { 
          service, 
          content, 
          due_time: dueTime, 
          advance_days: advanceDays, 
          recurring: recurring,
          cycle_mode: recurring ? cycleMode : null,
          cycle_days: (recurring && cycleMode === 'days') ? cycleDays : null
      };
      
      if (recurring && cycleMode === 'daily' && !dueTime) {
          // å¦‚æœç¼–è¾‘æ—¶æ²¡å¡«æ—¶é—´ï¼Œä¿ç•™åŸæ—¶é—´æˆ–è®¾ä¸ºä»Šå¤©
      } else {
          payload.due_time = dueTime;
      }

      await ApiService.reminders.update(id, payload);
      showMessage('æé†’å·²æ›´æ–°', 'success');
      closeEditReminder();
      await fetchReminders();
    } catch (error) {
      showMessage('ä¿å­˜å¤±è´¥', 'error');
      console.error('saveEditReminder:', error);
    }
  }

  /**
   * åˆ é™¤æé†’
   */
  async function deleteReminder(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæé†’å—ï¼Ÿ')) return;

    try {
      await ApiService.reminders.delete(id);
      showMessage('æé†’å·²åˆ é™¤', 'success');
      await fetchReminders();
    } catch (error) {
      showMessage('åˆ é™¤å¤±è´¥', 'error');
      console.error('deleteReminder:', error);
    }
  }

  /**
   * åˆ‡æ¢æé†’æ˜¾ç¤ºèŒƒå›´
   */
  // å·²ä¸å†ä½¿ç”¨çš„æé†’èŒƒå›´åˆ‡æ¢é€»è¾‘å·²ç§»é™¤ï¼Œç»Ÿä¸€ç”± AppState.reminderFilter æ§åˆ¶æ˜¾ç¤ºèŒƒå›´

  /**
   * è·å–åº”æ˜¾ç¤ºçš„æé†’åˆ—è¡¨
   */
  function getDisplayReminders() {
    const now = Date.now();
    const today = localIsoDate();

    if (AppState.reminderFilter === 'daily') {
      // è¿‡æ»¤å‡ºæ‰€æœ‰å¾ªç¯æ¨¡å¼ä¸º daily çš„ä»»åŠ¡
      return AppState.reminders.filter(r => r.cycle_mode === 'daily' || r.type === 'daily').sort((a, b) => (a.service || '').localeCompare(b.service));
    } 
    if (AppState.reminderFilter === 'all') {
      // æ˜¾ç¤ºæ‰€æœ‰æœªå®Œæˆçš„ä»»åŠ¡ï¼ˆåŒ…æ‹¬å¾ªç¯ä»»åŠ¡ï¼‰
      // å¯¹äºå¾ªç¯ä»»åŠ¡ï¼Œåªè¦å­˜åœ¨å°±æ˜¾ç¤ºï¼ˆå› ä¸ºå®ƒä»¬æ°¸è¿œæ˜¯â€œæœªå®Œæˆâ€çŠ¶æ€ï¼Œåªæ˜¯ due_time å˜äº†ï¼‰
      // ä½†ä¸ºäº†ä¸è®©åˆ—è¡¨å¤ªé•¿ï¼Œæˆ‘ä»¬åªæ˜¾ç¤ºï¼š
      // 1. ä¸€æ¬¡æ€§ä»»åŠ¡ä¸”æœªå¤„ç†
      // 2. å¾ªç¯ä»»åŠ¡ï¼ˆæ€»æ˜¯æ˜¾ç¤ºï¼Œæˆ–è€…åªæ˜¾ç¤ºæœ€è¿‘çš„ï¼Ÿï¼‰-> æ€»æ˜¯æ˜¾ç¤ºï¼Œæ–¹ä¾¿ç®¡ç†
      return AppState.reminders
        .filter(r => !r.processed || r.recurring)
        .sort((a, b) => (a.remind_time || a.due_time || '').localeCompare(b.remind_time || b.due_time || ''));
    } else {
      // é»˜è®¤è§†å›¾ï¼šåªæ˜¾ç¤ºâ€œéœ€è¦å…³æ³¨â€çš„
      // 1. å·²ç»åˆ°äº†æé†’æ—¶é—´ (remind_time <= today)
      // 2. ä¸”æœªå¤„ç† (processed=false)
      // 3. å¯¹äºå¾ªç¯ä»»åŠ¡ï¼Œå¦‚æœä»Šå¤©å·²ç»æ‰“å¡äº† (last_completed_date == today)ï¼Œåˆ™ä¸æ˜¾ç¤ºï¼ˆé™¤éå®ƒåˆè¿‡æœŸäº†ï¼Ÿï¼‰
      
      return AppState.reminders
        .filter(r => {
          // å·²å¤„ç†çš„ä¸€æ¬¡æ€§ä»»åŠ¡ä¸æ˜¾ç¤º
          if (!r.recurring && r.processed) return false;
          
          // è¿˜æ²¡åˆ°æé†’æ—¶é—´çš„ä¸æ˜¾ç¤º
          if (r.remind_time && r.remind_time > today) return false;
          
          // å¾ªç¯ä»»åŠ¡ç‰¹æ®Šé€»è¾‘ï¼š
          if (r.recurring) {
              // å¦‚æœæ˜¯æ¯æ—¥ä»»åŠ¡ï¼Œä¸”ä»Šå¤©å·²å®Œæˆï¼Œåˆ™éšè—
              if (r.cycle_mode === 'daily' && r.last_completed_date === today) return false;
              
              // å…¶ä»–å¾ªç¯ä»»åŠ¡ï¼Œå¦‚æœè¿˜æ²¡åˆ° due_timeï¼Œä½†åˆ°äº† remind_timeï¼Œæ˜¾ç¤º
              // å¦‚æœå·²ç»è¿‡äº† due_timeï¼Œè‚¯å®šæ˜¾ç¤º
          }
          
          return true;
        })
        .sort((a, b) => (a.remind_time || a.due_time || '').localeCompare(b.remind_time || b.due_time || ''));
    }
  }

  /**
   * æ¸²æŸ“æé†’åˆ—è¡¨
   */
  function renderReminders() {
    const displayReminders = getDisplayReminders();
    const today = localIsoDate();
    
    // è®¡ç®—æœªå¤„ç†æ•°é‡
    // é€»è¾‘ï¼šæ‰€æœ‰è¿‡æœŸæˆ–åˆ°æœŸæœªå¤„ç†çš„ä»»åŠ¡
    const unprocessedCount = AppState.reminders.filter(r => {
        if (!r.recurring && r.processed) return false;
        if (r.remind_time && r.remind_time > today) return false;
        if (r.recurring && r.cycle_mode === 'daily' && r.last_completed_date === today) return false;
        return true;
    }).length;

    if (DOM.statRemindersCount) DOM.statRemindersCount.textContent = String(unprocessedCount);

    if (displayReminders.length === 0) {
      DOM.reminderList.innerHTML = `<div class="empty-state empty-centered"><p class="empty-text">æš‚æ— æé†’äº‹é¡¹</p></div>`;
      return;
    }

    const html = displayReminders.map(r => {
      const isDaily = (r.cycle_mode === 'daily' || r.type === 'daily');
      const isDoneToday = isDaily && r.last_completed_date === today;
      
      // çŠ¶æ€å¾½ç« 
      let badgeHtml = '';
      if (isDaily) {
          badgeHtml = `<span class="priority-badge ${isDoneToday ? 'low' : 'high'}">æ¯æ—¥</span>`;
      } else if (r.recurring) {
          badgeHtml = `<span class="priority-badge medium">å¾ªç¯</span>`;
      } else {
          badgeHtml = `<span class="priority-badge low">ä¸€æ¬¡æ€§</span>`;
      }
      
      // æ—¶é—´æ˜¾ç¤º
      let timeHtml = '';
      if (r.due_time) {
          const due = r.due_time.split('T')[0];
          const isExpired = due < today;
          timeHtml = `<div class="reminder-time ${isExpired ? 'expired' : ''}">åˆ°æœŸï¼š${due}</div>`;
      }
      
      // æŒ‰é’®çŠ¶æ€
      const btnClass = (isDaily && isDoneToday) ? 'btn-ghost' : 'btn-primary';
      const btnText = (isDaily && isDoneToday) ? 'å·²æ‰“å¡' : 'å®Œæˆ';
      const btnDisabled = (isDaily && isDoneToday) ? 'disabled' : '';

      return `
        <div class="reminder-item ${isDoneToday ? 'completed' : ''}" data-id="${r.id}">
          <div class="reminder-header">
            <div class="reminder-title-wrap">
              <div class="reminder-service">${escapeHtml(r.service)}</div>
              ${badgeHtml}
            </div>
            <div class="reminder-actions">
              <button class="btn ${btnClass} btn-small process-reminder-btn" data-id="${r.id}" ${btnDisabled}>${btnText}</button>
              <button class="btn btn-secondary btn-small edit-reminder-btn" data-id="${r.id}">ç¼–è¾‘</button>
              <button class="btn btn-danger btn-small delete-reminder-btn" data-id="${r.id}">åˆ é™¤</button>
            </div>
          </div>
          <div class="reminder-content">${escapeHtml(r.content)}</div>
          ${timeHtml}
        </div>
      `;
    }).join('');

    DOM.reminderList.innerHTML = `<div class="reminder-list">${html}</div>`;

    // ç»‘å®šäº‹ä»¶
    DOM.reminderList.querySelectorAll('.process-reminder-btn').forEach(btn => {
      if (!btn.disabled) {
        btn.addEventListener('click', e => markReminderProcessed(e.target.dataset.id));
      }
    });
    DOM.reminderList.querySelectorAll('.edit-reminder-btn').forEach(btn => {
      btn.addEventListener('click', e => openEditReminder(e.target.dataset.id));
    });
    DOM.reminderList.querySelectorAll('.delete-reminder-btn').forEach(btn => {
      btn.addEventListener('click', e => deleteReminder(e.target.dataset.id));
    });
  }

  function renderServerStatus() {
    const list = AppState.serverStatus || [];
    const total = list.length;
    
    // ç»Ÿè®¡æ­£å¸¸/å¼‚å¸¸
    const successCount = list.filter(s => s.is_success).length;
    // const errorCount = list.length - successCount;
    
    if (DOM.statServices) DOM.statServices.textContent = `${total}`;
    
    if (total === 0) {
      DOM.serviceList.innerHTML = `<div class="empty-state empty-centered"><p class="empty-text">æš‚æ— æœåŠ¡çŠ¶æ€è®°å½•</p></div>`;
      return;
    }

    const html = list.map(item => {
      const isError = !item.is_success;
      const statusText = isError ? 'å¼‚å¸¸' : 'æ­£å¸¸';
      const statusClass = isError ? 'error' : 'success';
      const timeStr = item.received_at ? new Date(item.received_at).toLocaleString('zh-CN') : item.time;
      
      // å¤„ç† extra å­—æ®µ
      let extraHtml = '';
      if (item.extra && Object.keys(item.extra).length > 0) {
          const extraItems = Object.entries(item.extra).map(([key, value]) => {
              return `
                <div class="extra-item">
                  <div class="extra-key">${escapeHtml(key)}</div>
                  <div class="extra-val">${escapeHtml(String(value))}</div>
                </div>`;
          }).join('');
          extraHtml = `<div class="server-extra">${extraItems}</div>`;
      }

      return `
        <div class="server-card status-${statusClass}" onclick="this.classList.toggle('expanded')">
          <div class="server-summary">
            <div class="server-main-info">
                <div class="server-name-row">
                    <span class="server-name">${escapeHtml(item.server_name)}</span>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                    <span class="server-time" style="margin-left: auto;">${timeStr}</span>
                </div>
                <div class="server-brief">
                    ${item.service_name ? `<span class="brief-label">${escapeHtml(item.service_name)}:</span>` : ''}
                    <span class="brief-content">${escapeHtml(item.content || item.state_detail || '')}</span>
                </div>
            </div>
            <div class="server-expand-icon">
                <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </div>
          </div>
          
          <div class="server-details">
            ${extraHtml}
          </div>
        </div>
      `;
    }).join('');
    
    DOM.serviceList.innerHTML = `<div class="reminder-list">${html}</div>`;
  }

  async function fetchServerStatus() {
    try {
      const data = await ApiService.serverStatus.getAll(50);
      AppState.serverStatus = data;
      renderServerStatus();
    } catch (e) {
      console.error('fetchServerStatus error', e);
    }
  }

  // ============================================================================
  // è®°è´¦ï¼šCRUD ä¸æ¸²æŸ“
  // ============================================================================
  async function fetchLedger() {
    try {
      const [ledgerData, assetData, liabilityData] = await Promise.all([
        ApiService.ledger.getAll(),
        ApiService.ledger.getAsset(),
        ApiService.ledger.getLiability()
      ]);
      AppState.ledger = ledgerData;
      AppState.asset = assetData;
      AppState.liability = liabilityData;
      renderLedger();
    } catch (error) {
      showMessage('åŠ è½½è´¦å•å¤±è´¥', 'error');
      console.error('fetchLedger:', error);
    }
  }

  function renderLedger() {
    // 1. è®¡ç®—æœ¬æœˆæ”¶æ”¯
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    
    let monthlyIncome = 0;
    let monthlyExpense = 0;

    AppState.ledger.forEach(item => {
      const itemDate = new Date(item.record_date);
      if (itemDate.getMonth() === currentMonth && itemDate.getFullYear() === currentYear) {
        if (item.record_type === 'income') {
          monthlyIncome += item.amount;
        } else if (item.record_type === 'expense') {
          monthlyExpense += item.amount;
        }
      }
    });

    const totalAsset = AppState.asset ? AppState.asset.amount : 0;
    const totalLiability = AppState.liability ? AppState.liability.amount : 0;
    const netWorth = totalAsset - totalLiability;

    // Update Overview Panel Elements
    const elNetWorth = document.getElementById('overview-net-worth');
    const elAssets = document.getElementById('overview-assets');
    const elLiabilities = document.getElementById('overview-liabilities');
    const elIncome = document.getElementById('overview-income');
    const elExpense = document.getElementById('overview-expense');

    if (elNetWorth) {
        elNetWorth.textContent = `Â¥${netWorth.toFixed(2)}`;
        elNetWorth.style.color = netWorth >= 0 ? 'var(--text)' : 'var(--danger)';
    }
    if (elAssets) elAssets.textContent = `Â¥${totalAsset.toFixed(2)}`;
    if (elLiabilities) elLiabilities.textContent = `Â¥${totalLiability.toFixed(2)}`;
    if (elIncome) elIncome.textContent = `Â¥${monthlyIncome.toFixed(2)}`;
    if (elExpense) elExpense.textContent = `Â¥${monthlyExpense.toFixed(2)}`;

    // Update Dashboard Card (Small Card on Main Screen)
    if (DOM.statLedger) {
      const netWorthShort = netWorth;
      DOM.statLedger.textContent = `Â¥${netWorthShort.toFixed(0)}`;
      DOM.statLedger.style.color = netWorthShort >= 0 ? 'var(--success)' : 'var(--danger)';
      DOM.statLedger.title = `å‡€èµ„äº§: Â¥${netWorth.toFixed(2)}`;
    }

    if (DOM.statLedgerHint) {
      const assetW = (totalAsset / 10000).toFixed(1) + 'w';
      const liabilityW = (totalLiability / 10000).toFixed(1) + 'w';
      DOM.statLedgerHint.innerHTML = `
        <span style="color:var(--text-accent-muted)">èµ„ ${assetW}</span>
        <span style="margin:0 2px; opacity:0.3">|</span>
        <span style="color:var(--danger)">å€º ${liabilityW}</span>
      `;
    }

    // 2. æ¸²æŸ“åˆ—è¡¨ (Render List)
    if (!DOM.ledgerList) return;
    
    if (AppState.ledger.length === 0) {
      DOM.ledgerList.innerHTML = '<div class="empty-state">æš‚æ— è´¦å•è®°å½•</div>';
      return;
    }

    // Filter by Type if selected
    let displayLedger = [...AppState.ledger];
    if (AppState.ledgerFilterType) {
        if (AppState.ledgerFilterType === 'debt') {
             displayLedger = displayLedger.filter(item => item.record_type === 'debt_in' || item.record_type === 'debt_out');
        } else {
             displayLedger = displayLedger.filter(item => item.record_type === AppState.ledgerFilterType);
        }
    }

    // Filter by Category if selected
    if (AppState.ledgerFilterCategory) {
        displayLedger = displayLedger.filter(item => item.category === AppState.ledgerFilterCategory);
    }

    // Sort by date descending
    const sortedLedger = displayLedger.sort((a, b) => new Date(b.record_date) - new Date(a.record_date));

    const html = sortedLedger.map(item => {
      const date = new Date(item.record_date).toLocaleDateString('zh-CN');
      let amountClass = '';
      let sign = '';
      let typeText = '';
      let typeClass = '';
      
      if (item.record_type === 'income') {
          sign = '+';
          typeText = 'æ”¶å…¥';
          typeClass = 'income';
          amountClass = 'income';
      } else if (item.record_type === 'expense') {
          sign = '-';
          typeText = 'æ”¯å‡º';
          typeClass = 'expense';
          amountClass = 'expense';
      } else if (item.record_type === 'debt_in') {
          sign = '+';
          typeText = 'å€Ÿå…¥';
          typeClass = 'debt-in';
          amountClass = 'debt-in';
      } else if (item.record_type === 'debt_out') {
          sign = '-';
          typeText = 'è¿˜æ¬¾';
          typeClass = 'debt-out';
          amountClass = 'debt-out';
      }
      
      const interestInfo = (item.record_type === 'debt_out' && item.interest > 0) 
          ? `<div class="ledger-submeta">é¢å¤–åˆ©æ¯ Â¥${item.interest.toFixed(2)}</div>` 
          : '';
      
      return `
        <div class="ledger-item" data-id="${item.id}">
          <div class="ledger-header">
            <div class="ledger-title-wrap">
              <div class="ledger-title">${escapeHtml(item.item)}</div>
              ${typeText ? `<span class="ledger-type-badge ${typeClass}">${typeText}</span>` : ''}
            </div>
            <div class="ledger-actions">
              <span class="ledger-amount ${amountClass}">${sign}Â¥${item.amount.toFixed(2)}</span>
              <button class="btn btn-secondary btn-small edit-btn" onclick="openEditLedger(${item.id})">ç¼–è¾‘</button>
              <button class="btn btn-danger btn-small delete-btn" onclick="deleteLedger(${item.id})">åˆ é™¤</button>
            </div>
          </div>
          <div class="ledger-meta">
            <span class="ledger-date">${date}</span>
            ${item.category ? `<span class="tag-badge">${escapeHtml(item.category)}</span>` : ''}
            ${item.notes ? `<span class="ledger-notes">${escapeHtml(item.notes)}</span>` : ''}
          </div>
          ${interestInfo}
        </div>
      `;
    }).join('');

    DOM.ledgerList.innerHTML = `<div class="ledger-list">${html}</div>`;

    // Render Category Filters
    renderLedgerFilters();
  }

  function renderLedgerFilters() {
      const filterContainer = document.getElementById('ledger-filters');
      if (!filterContainer) return;

      // Collect all categories
      const categories = new Set();
      AppState.ledger.forEach(item => {
          if (item.category) categories.add(item.category);
      });

      if (categories.size === 0) {
          filterContainer.style.display = 'none';
          return;
      }
      filterContainer.style.display = 'flex';

      const activeCategory = AppState.ledgerFilterCategory || null;
      
      let html = `<button class="btn btn-ghost btn-small tag-filter-item ${!activeCategory ? 'active' : ''}" onclick="filterLedgerCategory(null)">å…¨éƒ¨</button>`;
      
      categories.forEach(cat => {
          html += `<button class="btn btn-ghost btn-small tag-filter-item ${activeCategory === cat ? 'active' : ''}" onclick="filterLedgerCategory('${escapeHtml(cat)}')">${escapeHtml(cat)}</button>`;
      });

      filterContainer.innerHTML = html;
  }

  function filterLedgerCategory(category) {
      AppState.ledgerFilterCategory = category;
      renderLedger();
  }

  function openLedgerForm() {
    AppState.editingLedgerId = null;
    DOM.ledgerItemInput.value = '';
    DOM.ledgerAmountInput.value = '';
    DOM.ledgerInterestInput.value = '';
    DOM.ledgerCategoryInput.value = '';
    DOM.ledgerNotesInput.value = '';
    // é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
    const today = new Date().toISOString().split('T')[0];
    DOM.ledgerDateInput.value = today;
    
    // Reset type and visibility
    DOM.ledgerTypeSelect.value = 'expense';
    document.getElementById('ledger-interest-group').style.display = 'none';
    
    openModal(DOM.ledgerFormModal);
  }

  function openEditLedger(id) {
    const item = AppState.ledger.find(l => l.id === id);
    if (!item) return;
    
    AppState.editingLedgerId = id;
    DOM.ledgerTypeSelect.value = item.record_type;
    DOM.ledgerItemInput.value = item.item;
    DOM.ledgerAmountInput.value = item.amount;
    DOM.ledgerInterestInput.value = item.interest || '';
    DOM.ledgerCategoryInput.value = item.category || '';
    DOM.ledgerNotesInput.value = item.notes || '';
    DOM.ledgerDateInput.value = item.record_date;
    
    // Update visibility
    const isDebtOut = item.record_type === 'debt_out';
    document.getElementById('ledger-interest-group').style.display = isDebtOut ? '' : 'none';
    
    openModal(DOM.ledgerFormModal);
  }

  function closeLedgerForm() {
    closeModal(DOM.ledgerFormModal);
    AppState.editingLedgerId = null;
  }

  async function saveLedger() {
    const record_type = DOM.ledgerTypeSelect.value;
    const item = DOM.ledgerItemInput.value.trim();
    const amountStr = DOM.ledgerAmountInput.value.trim();
    const interestStr = DOM.ledgerInterestInput.value.trim();
    const category = DOM.ledgerCategoryInput.value.trim();
    const notes = DOM.ledgerNotesInput.value.trim();
    const record_date = DOM.ledgerDateInput.value;

    if (!item || !amountStr || !record_date) {
      showMessage('è¯·å¡«å†™å¿…å¡«é¡¹ (é¡¹ç›®, é‡‘é¢, æ—¥æœŸ)', 'warning');
      return;
    }

    const amount = parseFloat(amountStr);
    if (isNaN(amount)) {
      showMessage('é‡‘é¢æ ¼å¼ä¸æ­£ç¡®', 'warning');
      return;
    }
    
    let interest = 0;
    if (record_type === 'debt_out') {
        const val = parseFloat(DOM.ledgerInterestInput.value);
        if (!isNaN(val)) {
            interest = val;
        }
    }

    try {
      const payload = { record_type, item, amount, interest, category, notes, record_date };
      if (AppState.editingLedgerId) {
        await ApiService.ledger.update(AppState.editingLedgerId, payload);
        showMessage('è´¦å•å·²æ›´æ–°', 'success');
      } else {
        await ApiService.ledger.create(payload);
        showMessage('è´¦å•å·²æ·»åŠ ', 'success');
      }
      closeLedgerForm();
      await fetchLedger();
    } catch (error) {
      showMessage('ä¿å­˜å¤±è´¥', 'error');
      console.error('saveLedger:', error);
    }
  }

  async function deleteLedger(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è´¦å•è®°å½•å—ï¼Ÿ')) return;
    try {
      await ApiService.ledger.delete(id);
      showMessage('è´¦å•å·²åˆ é™¤', 'success');
      await fetchLedger();
    } catch (error) {
      showMessage('åˆ é™¤å¤±è´¥', 'error');
      console.error('deleteLedger:', error);
    }
  }

  // ============================================================================
  // äº‹ä»¶ç»‘å®š
  // ============================================================================

  function setupEventListeners() {
    // æœç´¢åŠŸèƒ½å·²ç§»é™¤ï¼Œç›¸å…³äº‹ä»¶ç›‘å¬å·²åˆ é™¤ã€‚
    // ä¹¦ç­¾åŒºåŸŸä½œä¸ºå”¯ä¸€æ·»åŠ å…¥å£
    DOM.openBookmarkFormBtn.addEventListener('click', () => openBookmarkForm());
    DOM.openTodoFormBtn.addEventListener('click', openTodoForm);
    DOM.openReminderFormBtn.addEventListener('click', openReminderForm);
    DOM.openLedgerFormBtn.addEventListener('click', openLedgerForm);

    // Ledger Form
    DOM.ledgerTypeSelect = document.getElementById('ledger-type-select');
    DOM.ledgerInterestInput = document.getElementById('ledger-interest-input');
    
    DOM.ledgerTypeSelect.addEventListener('change', (e) => {
        const val = e.target.value;
        const interestGroup = document.getElementById('ledger-interest-group');
        if (val === 'debt_out') {
            interestGroup.style.display = '';
        } else {
            interestGroup.style.display = 'none';
            DOM.ledgerInterestInput.value = '';
        }
    });

    DOM.saveLedgerBtn.addEventListener('click', saveLedger);
    DOM.cancelLedgerFormBtn.addEventListener('click', closeLedgerForm);
    DOM.closeLedgerFormBtn.addEventListener('click', closeLedgerForm);

    // å¾ªç¯è®¾ç½®ï¼šå°†â€œæ¯æ—¥â€ä½œä¸ºå¾ªç¯æ¨¡å¼ä¹‹ä¸€ï¼ˆæ¯æ—¥ä¸éœ€è¦åˆ°æœŸ/æå‰è®¾ç½®ï¼‰
    DOM.reminderRecurringCheckbox.addEventListener('change', (e) => {
      const visible = e.target.checked ? '' : 'none';
      document.getElementById('reminder-cycle-group').style.display = visible;
      if (visible === '') {
        const mode = DOM.reminderCycleModeSelect.value;
        DOM.reminderCycleDaysGroup.style.display = (mode === 'days') ? '' : 'none';
        if (mode === 'daily' || mode === 'month_start') {
          document.getElementById('reminder-due-group').style.display = 'none';
          document.getElementById('reminder-advance-group').style.display = 'none';
        } else {
          document.getElementById('reminder-due-group').style.display = '';
          document.getElementById('reminder-advance-group').style.display = '';
        }
      } else {
        DOM.reminderCycleDaysGroup.style.display = 'none';
        document.getElementById('reminder-due-group').style.display = '';
        document.getElementById('reminder-advance-group').style.display = '';
      }
    });

    DOM.reminderCycleModeSelect.addEventListener('change', (e) => {
      const val = e.target.value;
      DOM.reminderCycleDaysGroup.style.display = val === 'days' ? '' : 'none';
      if (DOM.reminderRecurringCheckbox.checked) {
        if (val === 'daily' || val === 'month_start') {
          document.getElementById('reminder-due-group').style.display = 'none';
          document.getElementById('reminder-advance-group').style.display = 'none';
        } else {
          document.getElementById('reminder-due-group').style.display = '';
          document.getElementById('reminder-advance-group').style.display = '';
        }
      }
    });

    // ç¼–è¾‘è¡¨å•çš„å¾ªç¯è®¾ç½®
    DOM.editReminderRecurringCheckbox.addEventListener('change', (e) => {
      const visible = e.target.checked ? '' : 'none';
      document.getElementById('edit-reminder-cycle-group').style.display = visible;
      if (visible === '') {
        const mode = DOM.editReminderCycleModeSelect.value;
        DOM.editReminderCycleDaysGroup.style.display = (mode === 'days') ? '' : 'none';
        if (mode === 'daily' || mode === 'month_start') {
          document.getElementById('edit-reminder-due-group').style.display = 'none';
          document.getElementById('edit-reminder-advance-group').style.display = 'none';
        } else {
          document.getElementById('edit-reminder-due-group').style.display = '';
          document.getElementById('edit-reminder-advance-group').style.display = '';
        }
      } else {
        DOM.editReminderCycleDaysGroup.style.display = 'none';
        document.getElementById('edit-reminder-due-group').style.display = '';
        document.getElementById('edit-reminder-advance-group').style.display = '';
      }
    });

    DOM.editReminderCycleModeSelect.addEventListener('change', (e) => {
      const val = e.target.value;
      DOM.editReminderCycleDaysGroup.style.display = val === 'days' ? '' : 'none';
      if (DOM.editReminderRecurringCheckbox.checked) {
        if (val === 'daily' || val === 'month_start') {
          document.getElementById('edit-reminder-due-group').style.display = 'none';
          document.getElementById('edit-reminder-advance-group').style.display = 'none';
        } else {
          document.getElementById('edit-reminder-due-group').style.display = '';
          document.getElementById('edit-reminder-advance-group').style.display = '';
        }
      }
    });

    // å¾…åŠå’Œæé†’ï¼šå…¨å±æ–°ç•Œé¢ï¼ˆè¦†ç›–å±‚ï¼‰äº‹ä»¶å¤„ç†
    const statTodosCard = document.getElementById('stat-todos-card');
    const statRemindersCard = document.getElementById('stat-reminders-card');
    const statBookmarksCard = document.getElementById('stat-bookmarks-card');
    const statServicesCard = document.getElementById('stat-services-card');
    const statLedgerCard = document.getElementById('stat-ledger-card');
    const todosModal = document.getElementById('todos-modal');
    const remindersModal = document.getElementById('reminders-modal');
    const bookmarksModal = document.getElementById('bookmarks-modal');
    const servicesModal = document.getElementById('services-modal');
    const ledgerModal = document.getElementById('ledger-modal');
    const closeTodosModalBtn = document.getElementById('close-todos-modal-btn');
    const closeRemindersModalBtn = document.getElementById('close-reminders-modal-btn');
    const closeBookmarksModalBtn = document.getElementById('close-bookmarks-modal-btn');
    const closeServicesModalBtn = document.getElementById('close-services-modal-btn');
    const closeLedgerModalBtn = document.getElementById('close-ledger-modal-btn');

    function closeScreen(screenEl) {
      if (!screenEl) return;
      const panelEl = screenEl.querySelector('.screen-panel');
      const reduceMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      // è‹¥ä¸æ”¯æŒåŠ¨ç”»æˆ–ç”¨æˆ·åå¥½å‡å°‘åŠ¨ç”»ï¼Œç›´æ¥éšè—
      if (!panelEl || reduceMotion) {
        screenEl.classList.remove('show');
        screenEl.setAttribute('aria-hidden', 'true');
        // åœ¨éšè—å‰ç¡®ä¿ç„¦ç‚¹ç§»å‡º overlayï¼Œé¿å… aria-hidden è¦†ç›–ä»æœ‰ç„¦ç‚¹å…ƒç´ å¯¼è‡´çš„å¯è®¿é—®æ€§é—®é¢˜
        try { restoreFocusFrom(screenEl); } catch (e) { /* ignore */ }
        try { screenEl.inert = true; } catch (e) { /* inert may be unsupported */ }
        AppState.screenOpen = false;
        updateBodyOverflow();
        return;
      }

      // é˜²æ­¢é‡å¤å…³é—­
      if (screenEl.dataset.closing === '1') return;
      screenEl.dataset.closing = '1';

      // æ·»åŠ  closing ç±»ä»¥è§¦å‘ panel çš„æ·¡å‡ºä¸‹ç§»åŠ¨ç”»
      screenEl.classList.add('closing');
      // ç«‹å³å»é™¤é¡µé¢çš„æ¨¡ç³ŠçŠ¶æ€ï¼Œè®©æ¥æºå¡ç‰‡æ›´å¿«å¯è§
      document.body.classList.remove('screen-open');
      // åŒæ­¥è®© overlay æ›´å¿«æ·¡å‡ºå¹¶è§£é™¤é®ç½©äº¤äº’ï¼ˆä½¿ç”¨å†…è”æ ·å¼è¦†ç›– .showï¼‰
      try {
        // ç¼©çŸ­é®ç½©é€æ˜åº¦è¿‡æ¸¡ï¼Œä½¿èƒŒæ™¯æ›´å¿«å¯è§
        screenEl.style.transition = 'opacity 180ms linear';
        screenEl.style.opacity = '0';
        // å…è®¸èƒŒæ™¯äº¤äº’å°½æ—©å‘ç”Ÿï¼ˆä½† panel ä»åœ¨åšåŠ¨ç”»ï¼‰
        screenEl.style.pointerEvents = 'none';
      } catch (e) {
        // ignore
      }

      const onEnd = (e) => {
        // ç¡®ä¿æ˜¯ panel æœ¬èº«çš„ opacity è¿‡æ¸¡ç»“æŸå¹¶ä¸”å½“å‰ä»å¤„äº closing çŠ¶æ€ï¼Œé¿å…è¯¯è§¦å‘ï¼ˆä¾‹å¦‚æ‰“å¼€æ—¶çš„ transitionendï¼‰
        if (e.target !== panelEl) return;
        if (e.propertyName && e.propertyName !== 'opacity') return;
        if (!screenEl.classList.contains('closing') && screenEl.dataset.closing !== '1') return;

        panelEl.removeEventListener('transitionend', onEnd);
        screenEl.classList.remove('show', 'closing');
        screenEl.setAttribute('aria-hidden', 'true');
        try { restoreFocusFrom(screenEl); } catch (e) { /* ignore */ }
        try { screenEl.inert = true; } catch (e) { /* inert may be unsupported */ }
        AppState.screenOpen = false;
        delete screenEl.dataset.closing;
        // æ¸…ç†ä¹‹å‰è®¾ç½®çš„å†…è”æ ·å¼ï¼ˆoverlay/transition/pointer-eventsï¼‰
        screenEl.style.transition = '';
        screenEl.style.opacity = '';
        screenEl.style.pointerEvents = '';
        updateBodyOverflow();
      };

      panelEl.addEventListener('transitionend', onEnd);

      // å…œåº•ï¼šå¦‚æœ transitionend æœªè§¦å‘ï¼Œåˆ™åœ¨è¶…æ—¶åå¼ºåˆ¶æ¸…ç†
      setTimeout(() => {
        if (screenEl.dataset.closing === '1') {
          panelEl.removeEventListener('transitionend', onEnd);
          screenEl.classList.remove('show', 'closing');
          screenEl.setAttribute('aria-hidden', 'true');
          try { restoreFocusFrom(screenEl); } catch (e) { /* ignore */ }
          try { screenEl.inert = true; } catch (e) { /* inert may be unsupported */ }
          AppState.screenOpen = false;
          delete screenEl.dataset.closing;
          // æ¸…ç†å†…è”æ ·å¼
          screenEl.style.transition = '';
          screenEl.style.opacity = '';
          screenEl.style.pointerEvents = '';
          updateBodyOverflow();
        }
      }, 520);
    }

    function closeAllScreens() {
      closeScreen(todosModal);
      closeScreen(remindersModal);
      closeScreen(bookmarksModal);
      closeScreen(servicesModal);
      closeScreen(ledgerModal);
    }

    function openScreen(screenEl) {
      if (!screenEl) return;
      // äº’æ–¥ï¼šä¸€æ¬¡åªæ˜¾ç¤ºä¸€ä¸ªç•Œé¢
      closeAllScreens();
      // ç§»é™¤å¯èƒ½æ®‹ç•™çš„ closing çŠ¶æ€å’Œå…³é—­æ ‡å¿—ï¼Œç¡®ä¿æ‰“å¼€æ—¶ä¸ä¼šè¢«ä¹‹å‰çš„å…³é—­æµç¨‹å½±å“
      screenEl.classList.remove('closing');
      if (screenEl.dataset.closing) delete screenEl.dataset.closing;

      // é‡ç½®æ»šåŠ¨ä½ç½®
      const miniBody = screenEl.querySelector('.mini-body');
      if (miniBody) {
        miniBody.scrollTop = 0;
      }

      // æ¸…ç†å¯èƒ½æ®‹ç•™çš„å†…è”æ ·å¼ï¼ˆé®ç½©å¿«é€Ÿæ·¡å‡ºæ—¶å¯èƒ½ç•™ä¸‹ï¼‰
      try {
        screenEl.style.transition = '';
        screenEl.style.opacity = '';
        screenEl.style.pointerEvents = '';
        const panelEl = screenEl.querySelector('.screen-panel');
        if (panelEl) {
          panelEl.style.transition = '';
          panelEl.style.transform = '';
          panelEl.style.opacity = '';
          panelEl.style.willChange = '';
          panelEl.style.transformOrigin = '';
        }
      } catch (e) { /* ignore */ }

      screenEl.classList.add('show');
      screenEl.setAttribute('aria-hidden', 'false');
      // å½“é¢æ¿æ‰“å¼€æ—¶ç§»é™¤ inertï¼Œç¡®ä¿å†…éƒ¨æ§ä»¶å¯è¢«é”®ç›˜ä¸è¾…åŠ©æŠ€æœ¯è®¿é—®
      try { screenEl.inert = false; } catch (e) { /* inert å¯èƒ½åœ¨æ—§æµè§ˆå™¨ä¸å¯ç”¨ */ }
      AppState.screenOpen = true;
      updateBodyOverflow();
    }

    // æ‰“å¼€é¢æ¿ï¼ˆä½¿ç”¨ä¸å…³é—­ä¸€è‡´çš„ CSS è¿‡æ¸¡ï¼Œç§»é™¤ JS çš„å¡ç‰‡å˜å½¢åŠ¨ç”»ä»¥ä¿æŒä¸€è‡´ï¼‰
    function openScreenFromCard(sourceCardEl, screenEl) {
      if (!screenEl) return;
      const reduceMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      // å¦‚æœæä¾›äº†æ¥æºå¡ç‰‡ï¼Œè®°å½•å…¶ idï¼ˆç”¨äºå…³é—­æ—¶æŠŠç„¦ç‚¹æ¢å¤åˆ°æ¥æºå¡ç‰‡ï¼‰
      try {
        if (sourceCardEl && sourceCardEl.id) {
          screenEl.dataset.origin = sourceCardEl.id;
        } else {
          delete screenEl.dataset.origin;
        }
      } catch (e) { /* ignore */ }

      // ä»…è°ƒç”¨ openScreenï¼Œè®© CSS æ§åˆ¶è¿›å…¥åŠ¨ç”»ï¼ˆä¸å…³é—­åŠ¨ç”»å¯¹ç§°ï¼‰
      openScreen(screenEl);

      // å¦‚æœç”¨æˆ·åå¥½å‡å°‘åŠ¨ç”»ï¼Œæˆ–ä¸å­˜åœ¨æ¥æºå¡ç‰‡ï¼Œåˆ™ä¸åšé¢å¤–å¤„ç†
      if (reduceMotion || !sourceCardEl) return;

      // ä¸å†æ‰§è¡Œé¢å¤–çš„é«˜äº®æˆ–å˜å½¢åŠ¨ç”»ï¼Œä¿æŒè¿›å…¥ä¸é€€å‡ºè§†è§‰ä¸€è‡´
    }

    // ç®¡ç† overflow çŠ¶æ€çš„è¾…åŠ©å‡½æ•°
    function updateBodyOverflow() {
      const hasTodosModal = todosModal && todosModal.classList.contains('show');
      const hasRemindersModal = remindersModal && remindersModal.classList.contains('show');
      const hasBookmarksModal = bookmarksModal && bookmarksModal.classList.contains('show');
      const hasServicesModal = servicesModal && servicesModal.classList.contains('show');
      // Re-fetch to be absolutely sure
      const _ledgerModal = document.getElementById('ledger-modal');
      const hasLedgerModal = _ledgerModal && _ledgerModal.classList.contains('show');

      const hasAddTodoModal = DOM.addTodoModal && DOM.addTodoModal.style.display === 'flex';
      const hasEditTodoModal = DOM.editTodoModal && DOM.editTodoModal.style.display === 'flex';
      const hasReminderModal = DOM.reminderModal && DOM.reminderModal.style.display === 'flex';
      const hasBookmarkModal = DOM.bookmarkModal && DOM.bookmarkModal.style.display === 'flex';
      const hasEditBookmarkModal = DOM.editBookmarkModal && DOM.editBookmarkModal.style.display === 'flex';
      const hasLedgerFormModal = DOM.ledgerFormModal && DOM.ledgerFormModal.style.display === 'flex';

      // å¾…åŠ/æé†’â€œæ–°ç•Œé¢â€æ‰“å¼€æ—¶ï¼Œè™šåŒ–åº•å±‚å†…å®¹ï¼ˆç”± CSS æ§åˆ¶ï¼‰
      if (hasTodosModal || hasRemindersModal || hasBookmarksModal || hasServicesModal || hasLedgerModal) {
        document.body.classList.add('screen-open');
      } else {
        document.body.classList.remove('screen-open');
      }
      
      if (hasTodosModal || hasRemindersModal || hasBookmarksModal || hasServicesModal || hasLedgerModal || hasAddTodoModal || hasEditTodoModal || hasReminderModal || hasBookmarkModal || hasEditBookmarkModal || hasLedgerFormModal) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    }

    // åœ¨éšè— overlay ä¹‹å‰ï¼Œç¡®ä¿å†…éƒ¨è·å¾—ç„¦ç‚¹çš„å…ƒç´ å¤±å»ç„¦ç‚¹å¹¶å°†ç„¦ç‚¹æ¢å¤åˆ°å®‰å…¨ä½ç½®ã€‚
    // è¿™æ ·å¯ä»¥é¿å…åœ¨å¯¹å…ƒç´ æˆ–å…¶ç¥–å…ˆè®¾ç½® `aria-hidden` æ—¶é€ æˆè¾…åŠ©æŠ€æœ¯ç”¨æˆ·æ— æ³•è®¿é—®å·²èšç„¦é¡¹çš„é—®é¢˜ã€‚
    function restoreFocusFrom(screenEl) {
      try {
        const active = document.activeElement;
        if (!active) return;
        if (!screenEl.contains(active)) return;

        // å…ˆå°è¯• blur å½“å‰èšç„¦å…ƒç´ 
        try { active.blur(); } catch (e) { /* ignore */ }

        // å¦‚æœè®°å½•äº†æ¥æºå…ƒç´  idï¼Œå°è¯•å°†ç„¦ç‚¹ç§»å›æ¥æº
        const originId = screenEl.dataset.origin;
        let target = null;
        if (originId) target = document.getElementById(originId);

        if (target) {
          try { target.focus(); } catch (e) { /* ignore */ }
          return;
        }

        // å…œåº•ï¼šè®© body ä¸´æ—¶å¯èšç„¦å¹¶ focusï¼Œéšåæ¢å¤åŸçŠ¶æ€
        try {
          const body = document.body;
          const prevTab = body.getAttribute('tabindex');
          body.setAttribute('tabindex', '-1');
          body.focus();
          if (prevTab === null) body.removeAttribute('tabindex'); else body.setAttribute('tabindex', prevTab);
        } catch (e) { /* ignore */ }
      } catch (e) { /* ignore */ }
    }

    // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ¨¡æ€æ¡†æ‰“å¼€
    function isAnyScreenOpen() {
      return (todosModal && todosModal.classList.contains('show')) ||
             (remindersModal && remindersModal.classList.contains('show')) ||
             (bookmarksModal && bookmarksModal.classList.contains('show')) ||
             (servicesModal && servicesModal.classList.contains('show')) ||
             (ledgerModal && ledgerModal.classList.contains('show'));
    }

    // æ‰“å¼€å¾…åŠç•Œé¢
    if (statTodosCard && todosModal) {
      statTodosCard.addEventListener('click', (e) => {
        // å½“ä»»ä½•æ¨¡æ€æ¡†æ‰“å¼€æ—¶ï¼Œå®Œå…¨å¿½ç•¥ç‚¹å‡»
        if (AppState.screenOpen) {
          e.preventDefault();
          e.stopPropagation();
          return;
        }
        
        e.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡
        // æ²¡æœ‰ä»»ä½•æ¨¡æ€æ¡†æ‰“å¼€ï¼Œæ‰èƒ½æ‰§è¡Œæ‰“å¼€æ“ä½œ
        AppState.todoFilterPriority = 'all';
        document.querySelectorAll('.filter-todo-btn').forEach(b => b.classList.remove('active'));
        const allBtn = document.querySelector('.filter-todo-btn[data-priority="all"]');
        if (allBtn) allBtn.classList.add('active');
        renderTodos();
        openScreenFromCard(statTodosCard, todosModal);
      });
    }

    // æ‰“å¼€æé†’ç•Œé¢
    if (statRemindersCard && remindersModal) {
      statRemindersCard.addEventListener('click', (e) => {
        // å½“ä»»ä½•æ¨¡æ€æ¡†æ‰“å¼€æ—¶ï¼Œå®Œå…¨å¿½ç•¥ç‚¹å‡»
        if (AppState.screenOpen) {
          e.preventDefault();
          e.stopPropagation();
          return;
        }
        
        e.stopPropagation();
        openScreenFromCard(statRemindersCard, remindersModal);
      });
    }

    // æ‰“å¼€ä¹¦ç­¾ç•Œé¢
    if (statBookmarksCard && bookmarksModal) {
      statBookmarksCard.addEventListener('click', (e) => {
        // å½“ä»»ä½•æ¨¡æ€æ¡†æ‰“å¼€æ—¶ï¼Œå®Œå…¨å¿½ç•¥ç‚¹å‡»
        if (AppState.screenOpen) {
          e.preventDefault();
          e.stopPropagation();
          return;
        }
        
        e.stopPropagation();
        openScreenFromCard(statBookmarksCard, bookmarksModal);
      });
    }

    // æ‰“å¼€æœåŠ¡ç•Œé¢
    if (statServicesCard && servicesModal) {
      statServicesCard.addEventListener('click', (e) => {
        // å½“ä»»ä½•æ¨¡æ€æ¡†æ‰“å¼€æ—¶ï¼Œå®Œå…¨å¿½ç•¥ç‚¹å‡»
        if (AppState.screenOpen) {
          e.preventDefault();
          e.stopPropagation();
          return;
        }
        
        e.stopPropagation();
        fetchServerStatus();
        openScreenFromCard(statServicesCard, servicesModal);
      });
    }

    // æ‰“å¼€è®°è´¦ç•Œé¢
    if (statLedgerCard && ledgerModal) {
      statLedgerCard.addEventListener('click', (e) => {
        if (AppState.screenOpen) {
          e.preventDefault();
          e.stopPropagation();
          return;
        }
        e.stopPropagation();
        fetchLedger();
        openScreenFromCard(statLedgerCard, ledgerModal);
      });
    }

    // ç‚¹å‡»ç©ºç™½å¤„å…³é—­å·²ç¦ç”¨ï¼šæ”¹ä¸ºä¸å“åº”é®ç½©/é¢æ¿å†…ç©ºç™½ç‚¹å‡»ï¼Œåªç”¨æ˜¾å¼è¿”å›æŒ‰é’®å…³é—­
    function bindBlankClose(screenEl) {
      if (!screenEl) return;

      // overlay ç‚¹å‡»å¤„ç†ï¼šä¸å†é€šè¿‡ç‚¹å‡»é®ç½©å…³é—­ç•Œé¢ï¼Œä»…é˜»æ­¢äº‹ä»¶ç©¿é€
      screenEl.addEventListener('click', e => {
        const panel = e.target && e.target.closest ? e.target.closest('.screen-panel') : null;
        
        if (!panel) {
          // ç‚¹å‡»åœ¨é¢æ¿å¤–ï¼ˆé®ç½©åŒºåŸŸï¼‰ -> ä¸å…³é—­ï¼Œä»…é˜»æ­¢äº‹ä»¶å†’æ³¡å’Œé»˜è®¤è¡Œä¸º
          e.stopPropagation();
          e.preventDefault();
          return;
        }
        // å¦‚æœç‚¹å‡»åœ¨é¢æ¿ä¸Šï¼Œè®©äº‹ä»¶ç»§ç»­ä¼ æ’­ç»™é¢æ¿çš„ç›‘å¬å™¨
      }, true); // æ•è·é˜¶æ®µ

      // panel å†…ç©ºç™½ä¸å†å…³é—­ï¼šé˜»æ­¢ç©ºç™½åŒºåŸŸçš„ç‚¹å‡»å†’æ³¡ä»¥é¿å…æ„å¤–å…³é—­
      const panelEl = screenEl.querySelector('.screen-panel');
      if (!panelEl) return;
      panelEl.addEventListener('click', e => {
        const t = e.target;
        if (!t || !t.closest) return;

        // ä»»ä½•æ˜æ˜¾äº¤äº’æ§ä»¶å…è®¸ç»§ç»­ï¼ˆæŒ‰é’®/é“¾æ¥/è¾“å…¥ï¼‰
        if (t.closest('button,a,input,textarea,select,option,label')) return;

        // ç‚¹åœ¨å…·ä½“å†…å®¹æ¡ç›®ä¸Šå…è®¸ç»§ç»­
        if (t.closest('.todo-item,.reminder-item,.bookmark-item,.server-card,.overview-clickable')) return;

        // å…¶ä½™è§†ä½œâ€œç©ºç™½åŒºåŸŸâ€ï¼Œä»…é˜»æ­¢äº‹ä»¶å†’æ³¡
        e.stopPropagation();
      }, true); // æ•è·é˜¶æ®µ
    }

    bindBlankClose(todosModal);
    bindBlankClose(remindersModal);
    bindBlankClose(bookmarksModal);
    bindBlankClose(servicesModal);
    bindBlankClose(ledgerModal);

    // è¿”å›æŒ‰é’®ç»‘å®šï¼ˆæ˜¾å¼å…³é—­ï¼‰ï¼šä»…é€šè¿‡æŒ‰é’®å…³é—­ç•Œé¢ï¼Œç¦ç”¨é®ç½©ç‚¹å‡»å…³é—­
    if (closeTodosModalBtn) {
      closeTodosModalBtn.addEventListener('click', () => {
        closeScreen(todosModal);
      });
    }
    if (closeRemindersModalBtn) {
      closeRemindersModalBtn.addEventListener('click', () => {
        closeScreen(remindersModal);
      });
    }
    if (closeBookmarksModalBtn) {
      closeBookmarksModalBtn.addEventListener('click', () => {
        closeScreen(bookmarksModal);
      });
    }
    if (closeServicesModalBtn) {
      closeServicesModalBtn.addEventListener('click', () => {
        closeScreen(servicesModal);
      });
    }
    if (closeLedgerModalBtn) {
      closeLedgerModalBtn.addEventListener('click', () => {
        closeScreen(ledgerModal);
        // Reset Ledger View to Overview
        setTimeout(() => {
            const ledgerOverviewPanel = document.getElementById('ledger-overview-panel');
            const ledgerDetailsPanel = document.getElementById('ledger-details-panel');
            const ledgerBackBtn = document.getElementById('ledger-back-btn');
            const ledgerModalTitle = document.getElementById('ledger-modal-title');
            
            if (ledgerOverviewPanel) ledgerOverviewPanel.style.display = 'flex';
            if (ledgerDetailsPanel) ledgerDetailsPanel.style.display = 'none';
            if (ledgerBackBtn) ledgerBackBtn.style.display = 'none';
            if (ledgerModalTitle) ledgerModalTitle.textContent = 'èµ„äº§æ€»è§ˆ';
            
            AppState.ledgerFilterType = null;
            AppState.ledgerFilterCategory = null;
        }, 300);
      });
    }

    // Ledger View Toggle Logic
    const ledgerBackBtn = document.getElementById('ledger-back-btn');
    const ledgerOverviewPanel = document.getElementById('ledger-overview-panel');
    const ledgerDetailsPanel = document.getElementById('ledger-details-panel');
    const ledgerModalTitle = document.getElementById('ledger-modal-title');

    function switchPanel(fromPanel, toPanel, onComplete) {
        if (!fromPanel || !toPanel) return;
        
        // 1. Fade out current
        fromPanel.classList.add('panel-fade-out');
        
        // 2. Wait for transition (match CSS --transition-panel: 420ms)
        setTimeout(() => {
            fromPanel.style.display = 'none';
            fromPanel.classList.remove('panel-fade-out');
            
            // 3. Prepare next panel (hidden but display flex)
            toPanel.classList.add('panel-fade-in');
            toPanel.style.display = 'flex';
            
            // Force reflow
            void toPanel.offsetWidth;
            
            // 4. Fade in next
            toPanel.classList.remove('panel-fade-in');
            
            if (onComplete) onComplete();
        }, 300); // Slightly faster than full 420ms for snappier feel while keeping the curve
    }

    function showLedgerDetails(filterType, title) {
        AppState.ledgerFilterType = filterType;
        AppState.ledgerFilterCategory = null; // Reset category
        renderLedger();
        
        if (ledgerModalTitle) ledgerModalTitle.textContent = title || 'è´¦å•æ˜ç»†';
        if (ledgerBackBtn) ledgerBackBtn.style.display = 'inline-block';

        switchPanel(ledgerOverviewPanel, ledgerDetailsPanel);
    }

    const cardNetWorth = document.getElementById('overview-card-net-worth');
    const cardAssets = document.getElementById('overview-card-assets');
    const cardLiabilities = document.getElementById('overview-card-liabilities');
    const cardIncome = document.getElementById('overview-card-income');
    const cardExpense = document.getElementById('overview-card-expense');

    if (cardNetWorth) cardNetWorth.addEventListener('click', () => showLedgerDetails(null, 'æ‰€æœ‰è´¦å•'));
    if (cardAssets) cardAssets.addEventListener('click', () => showLedgerDetails(null, 'æ‰€æœ‰èµ„äº§'));
    if (cardLiabilities) cardLiabilities.addEventListener('click', () => showLedgerDetails('debt', 'è´Ÿå€ºæ˜ç»†'));
    if (cardIncome) cardIncome.addEventListener('click', () => showLedgerDetails('income', 'æ”¶å…¥æ˜ç»†'));
    if (cardExpense) cardExpense.addEventListener('click', () => showLedgerDetails('expense', 'æ”¯å‡ºæ˜ç»†'));

    if (ledgerBackBtn) {
        ledgerBackBtn.addEventListener('click', () => {
            if (ledgerModalTitle) ledgerModalTitle.textContent = 'èµ„äº§æ€»è§ˆ';
            if (ledgerBackBtn) ledgerBackBtn.style.display = 'none';
            
            switchPanel(ledgerDetailsPanel, ledgerOverviewPanel, () => {
                AppState.ledgerFilterType = null;
                AppState.ledgerFilterCategory = null;
            });
        });
    }
    if (DOM.refreshServicesBtn) {
      DOM.refreshServicesBtn.addEventListener('click', fetchServerStatus);
    }

    // å¾…åŠè¡¨å•
    DOM.closeAddTodoBtn.addEventListener('click', () => {
      closeTodoForm();
      updateBodyOverflow();
    });
    DOM.cancelAddTodoBtn.addEventListener('click', () => {
      closeTodoForm();
      updateBodyOverflow();
    });
    DOM.addTodoBtn.addEventListener('click', () => {
      addTodo();
    });
    DOM.todoInput.addEventListener('keyup', e => {
      if (e.key === 'Enter') {
        addTodo();
      } else if (e.key === 'Escape') {
        closeTodoForm();
        updateBodyOverflow();
      }
    });

    // å¾…åŠç¼–è¾‘
    DOM.closeEditTodoBtn.addEventListener('click', () => {
      closeEditTodo();
      updateBodyOverflow();
    });
    DOM.cancelEditTodoBtn.addEventListener('click', () => {
      closeEditTodo();
      updateBodyOverflow();
    });
    DOM.saveEditTodoBtn.addEventListener('click', saveEditTodo);

    // æé†’è¡¨å•
    DOM.closeReminderModalBtn.addEventListener('click', () => {
      closeReminderForm();
      updateBodyOverflow();
    });
    DOM.cancelReminderBtn.addEventListener('click', () => {
      closeReminderForm();
      updateBodyOverflow();
    });
    DOM.addReminderBtn.addEventListener('click', addReminder);

    // å¾…åŠä¼˜å…ˆçº§è¿‡æ»¤æŒ‰é’®
    document.querySelectorAll('.filter-todo-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const priority = btn.dataset.priority;
        AppState.todoFilterPriority = priority;
        
        // æ›´æ–°æŒ‰é’®æ¿€æ´»çŠ¶æ€
        document.querySelectorAll('.filter-todo-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        renderTodos();
      });
    });

    // æé†’è¿‡æ»¤æŒ‰é’®
    document.querySelectorAll('.filter-reminder-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const filter = btn.dataset.filter;
        AppState.reminderFilter = filter;
        
        // æ›´æ–°æŒ‰é’®æ¿€æ´»çŠ¶æ€
        document.querySelectorAll('.filter-reminder-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        renderReminders();
      });
    });

    // ä¹¦ç­¾äº‹ä»¶ï¼ˆä¿ç•™ï¼‰
    DOM.closeBookmarkModalBtn.addEventListener('click', () => {
      closeBookmarkForm();
      updateBodyOverflow();
    });
    DOM.cancelBookmarkBtn.addEventListener('click', () => {
      closeBookmarkForm();
      updateBodyOverflow();
    });

    // æ ‡ç­¾é€‰æ‹©å™¨æ¨¡æ€ç›¸å…³äº‹ä»¶
    if (DOM.openTagFilterBtn) DOM.openTagFilterBtn.addEventListener('click', openTagFilter);
    if (DOM.closeTagFilterBtn) DOM.closeTagFilterBtn.addEventListener('click', () => { 
      // header X: clear selected filter tags and refresh
      AppState.bookmarkFilterTags = [];
      renderBookmarks();
      closeModal(DOM.tagFilterModal); updateBodyOverflow();
    });
    if (DOM.cancelTagFilterBtn) DOM.cancelTagFilterBtn.addEventListener('click', () => { closeModal(DOM.tagFilterModal); updateBodyOverflow(); });
    if (DOM.closeTagSelectBtn) DOM.closeTagSelectBtn.addEventListener('click', () => { 
      // header X: clear selected filter tags and refresh
      AppState.bookmarkFilterTags = [];
      renderBookmarks();
      closeTagSelector(); updateBodyOverflow();
    });
    if (DOM.cancelTagSelectBtn) DOM.cancelTagSelectBtn.addEventListener('click', () => { closeTagSelector(); updateBodyOverflow(); });
    
    // åˆå§‹åŒ–ä¹¦ç­¾æ ‡ç­¾ç¼–è¾‘å™¨
    const bookmarkTagsEditor = new TagsEditor(
      'bookmark-tags-input',
      'bookmark-tags-container'
    );
    
    // ç¼–è¾‘ä¹¦ç­¾æ ‡ç­¾ç¼–è¾‘å™¨
    const editBookmarkTagsEditor = new TagsEditor(
      'edit-bookmark-tags-input',
      'edit-bookmark-tags-container'
    );
    
    // ä¿å­˜å‰åŒæ­¥æ ‡ç­¾åˆ°ç¼–è¾‘å™¨
    function syncBookmarkTags() {
      return bookmarkTagsEditor.getTags();
    }
    
    function syncEditBookmarkTags() {
      return editBookmarkTagsEditor.getTags();
    }
    
    // æ‰“å¼€ä¹¦ç­¾è¡¨å•æ—¶åˆå§‹åŒ–ç¼–è¾‘å™¨
    const originalOpenBookmarkForm = openBookmarkForm;
    openBookmarkForm = function() {
      originalOpenBookmarkForm();
      bookmarkTagsEditor.reset();
    };
    
    // ç¼–è¾‘ä¹¦ç­¾æ—¶åŠ è½½æ ‡ç­¾
    const originalOpenEditBookmark = openEditBookmark;
    openEditBookmark = function(id) {
      originalOpenEditBookmark(id);
      const bm = AppState.bookmarks.find(b => b.id == id);
      if (bm && bm.tags) {
        editBookmarkTagsEditor.setTags(bm.tags);
      } else {
        editBookmarkTagsEditor.reset();
      }
    };
    
    // è¦†ç›– addBookmark ä½¿ç”¨ç¼–è¾‘å™¨çš„æ ‡ç­¾
    addBookmark = async function() {
      const title = DOM.bookmarkTitleInput.value.trim();
      const url = DOM.bookmarkUrlInput.value.trim();
      const description = DOM.bookmarkDescriptionInput.value.trim();
      const tags = syncBookmarkTags();
      
      if (!title || !url) {
        showMessage('è¯·è¾“å…¥åç§°ä¸ç½‘å€', 'warning');
        return;
      }
      
      try {
        await ApiService.bookmarks.create({ title, url, description, tags });
        showMessage('ä¹¦ç­¾å·²æ·»åŠ ', 'success');
        closeBookmarkForm();
        await fetchBookmarks();
      } catch (error) {
        showMessage('æ·»åŠ å¤±è´¥', 'error');
        console.error('addBookmark:', error);
      }
    };
    
    // è¦†ç›– saveEditBookmark ä½¿ç”¨ç¼–è¾‘å™¨çš„æ ‡ç­¾
    saveEditBookmark = async function() {
      if (!AppState.editingBookmarkId) return;
      const title = DOM.editBookmarkTitleInput.value.trim();
      const url = DOM.editBookmarkUrlInput.value.trim();
      const description = DOM.editBookmarkDescriptionInput.value.trim();
      const tags = syncEditBookmarkTags();
      
      if (!title || !url) {
        showMessage('åç§°ä¸ç½‘å€ä¸èƒ½ä¸ºç©º', 'warning');
        return;
      }
      
      try {
        await ApiService.bookmarks.update(AppState.editingBookmarkId, { title, url, tags, description });
        showMessage('ä¹¦ç­¾å·²æ›´æ–°', 'success');
        closeEditBookmark();
        await fetchBookmarks();
      } catch (error) {
        showMessage('ä¿å­˜å¤±è´¥', 'error');
        console.error('saveEditBookmark:', error);
      }
    };
    
    DOM.addBookmarkBtn.addEventListener('click', addBookmark);
    DOM.closeEditBookmarkBtn.addEventListener('click', () => {
      closeEditBookmark();
      updateBodyOverflow();
    });
    DOM.cancelEditBookmarkBtn.addEventListener('click', () => {
      closeEditBookmark();
      updateBodyOverflow();
    });
    DOM.saveEditBookmarkBtn.addEventListener('click', saveEditBookmark);

    // ç¼–è¾‘æé†’äº‹ä»¶å¤„ç†
    DOM.closeEditReminderBtn.addEventListener('click', () => {
      closeEditReminder();
      updateBodyOverflow();
    });
    DOM.cancelEditReminderBtn.addEventListener('click', () => {
      closeEditReminder();
      updateBodyOverflow();
    });
    DOM.saveEditReminderBtn.addEventListener('click', saveEditReminder);

    // æ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»å…³é—­
    DOM.addTodoModal.addEventListener('click', e => {
      if (e.target === DOM.addTodoModal) {
        closeTodoForm();
        updateBodyOverflow();
      }
    });
    DOM.editTodoModal.addEventListener('click', e => {
      if (e.target === DOM.editTodoModal) {
        closeEditTodo();
        updateBodyOverflow();
      }
    });
    DOM.reminderModal.addEventListener('click', e => {
      if (e.target === DOM.reminderModal) {
        closeReminderForm();
        updateBodyOverflow();
      }
    });
    DOM.bookmarkModal.addEventListener('click', e => {
      if (e.target === DOM.bookmarkModal) {
        closeBookmarkForm();
        updateBodyOverflow();
      }
    });
    DOM.editBookmarkModal.addEventListener('click', e => {
      if (e.target === DOM.editBookmarkModal) {
        closeEditBookmark();
        updateBodyOverflow();
      }
    });
    DOM.editReminderModal.addEventListener('click', e => {
      if (e.target === DOM.editReminderModal) {
        closeEditReminder();
        updateBodyOverflow();
      }
    });

    // When action buttons are hovered/focused, expand card padding to accommodate scaled buttons
    if (DOM.bookmarkGrid) {
      DOM.bookmarkGrid.addEventListener('pointerover', e => {
        const btn = e.target.closest && e.target.closest('.bookmark-block-actions .btn');
        if (!btn) return;
        const block = btn.closest && btn.closest('.bookmark-block');
        if (block) block.classList.add('action-expanded');
      });
      DOM.bookmarkGrid.addEventListener('pointerout', e => {
        const btn = e.target.closest && e.target.closest('.bookmark-block-actions .btn');
        if (!btn) return;
        const block = btn.closest && btn.closest('.bookmark-block');
        if (block) block.classList.remove('action-expanded');
      });
      // Keyboard accessibility: focusin/out
      DOM.bookmarkGrid.addEventListener('focusin', e => {
        const btn = e.target.closest && e.target.closest('.bookmark-block-actions .btn');
        if (!btn) return;
        const block = btn.closest && btn.closest('.bookmark-block');
        if (block) block.classList.add('action-expanded');
      });
      DOM.bookmarkGrid.addEventListener('focusout', e => {
        const btn = e.target.closest && e.target.closest('.bookmark-block-actions .btn');
        if (!btn) return;
        const block = btn.closest && btn.closest('.bookmark-block');
        if (block) block.classList.remove('action-expanded');
      });
    }

    // ESC é”®å…³é—­æ‰€æœ‰å¼¹çª—ï¼ˆå¾…åŠ/æé†’ç•Œé¢ + modalï¼‰
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        // å…ˆå…³â€œå¾…åŠ/æé†’â€å…¨å±ç•Œé¢
        closeAllScreens();
        if (DOM.addTodoModal.style.display === 'flex') {
          closeTodoForm();
          updateBodyOverflow();
        }
        if (DOM.editTodoModal.style.display === 'flex') {
          closeEditTodo();
          updateBodyOverflow();
        }
        if (DOM.reminderModal.style.display === 'flex') {
          closeReminderForm();
          updateBodyOverflow();
        }
        if (DOM.bookmarkModal.style.display === 'flex') {
          closeBookmarkForm();
          updateBodyOverflow();
        }
        if (DOM.editBookmarkModal.style.display === 'flex') {
          closeEditBookmark();
          updateBodyOverflow();
        }
      }
    });
  }

  // ============================================================================
  // åº”ç”¨åˆå§‹åŒ–
  // ============================================================================

  /**
   * åˆå§‹åŒ–åº”ç”¨æ•°æ®
   */
  async function initApp() {
    await Promise.all([fetchBookmarks(), fetchTodos(), fetchReminders(), fetchServerStatus(), fetchLedger()]);
  }

  /**
   * å¯åŠ¨åº”ç”¨
   */
  async function start() {
    // åŠ è½½ä¸»é¢˜
    try {
      await Promise.race([
        fetchAndApplyThemeColor(),
        new Promise(res => setTimeout(res, 800))
      ]);
    } catch (e) {
      setThemeVariables(FALLBACK_THEME);
    }

    await fetchAndApplyThemeBackground();

    // æ˜¾ç¤ºå†…å®¹
    const loading = document.getElementById('loading');
    const content = document.getElementById('content');
    const bgLayer = document.getElementById('bg-layer');
    
    if (loading) loading.style.display = 'none';
    
    // è§¦å‘èƒŒæ™¯åŠ¨ç”»
    if (bgLayer) {
        // ä½¿ç”¨ setTimeout ç¡®ä¿ DOM æ›´æ–°åè§¦å‘ transition
        setTimeout(() => {
            bgLayer.classList.add('loaded');
        }, 50);
    }

    // èƒŒæ™¯åŠ¨ç”»æ’­æ”¾å¤§éƒ¨åˆ†åï¼ˆ1.2ç§’ï¼‰ï¼Œå†æ˜¾ç¤ºå†…å®¹
    if (content) {
        content.style.display = 'block';
        setTimeout(() => {
            content.classList.add('visible');
        }, 1200);
    }

    // åˆå§‹æ—¶ä¸ºæ‰€æœ‰è¢« aria-hidden æ ‡è®°çš„å±å¹• overlay è®¾ç½® inertï¼Œé˜²æ­¢å…¶å­å…ƒç´ è¢«èšç„¦
    try {
      document.querySelectorAll('.screen-overlay[aria-hidden="true"]').forEach(el => {
        try { el.inert = true; } catch (e) { /* ignore if unsupported */ }
      });
    } catch (e) { /* ignore */ }

    // ç»‘å®šäº‹ä»¶å’Œåˆå§‹åŒ–æ•°æ®
    setupEventListeners();
    await initApp();
  }

  // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', start);
  } else {
    start();
  }
</script>
</body>
</html>
